<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="JJMJ's blog."><meta name="keywords" content="Java, Spring, MyBatis, 后端"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>Nginx | 掘金木匠</title><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx</h1><a id="logo" href="/.">掘金木匠</a><p class="description">懂金融的软件工程师一定是一个合格的吃货</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Nginx</h1><div class="post-meta"><a href="/2020/03/29/Nginx%E5%9F%BA%E7%A1%80/#comments" class="comment-count"><i id="changyan_count_unit" data-xid="2020/03/29/Nginx基础/"></i>留言,<i id="changyan_parti_unit" data-xid="2020/03/29/Nginx基础/"></i>参与</a><p><span class="date">Mar 29, 2020</span><span><a href="/categories/Web%E5%BC%80%E5%8F%91/" class="category">Web开发</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h1 id="1-Nginx简介"><a href="#1-Nginx简介" class="headerlink" title="1 Nginx简介"></a>1 Nginx简介</h1><ul>
<li>Nginx是<strong>开源</strong>，<strong>高性能</strong>，<strong>高可靠的</strong>Http Web服务、代理服务、负载均衡<ul>
<li>高性能：支持海量并发，有报告表明能支持高达50, 000个并发连接数</li>
<li>可靠：服务稳定 </li>
<li>轻量：占用内存资源少</li>
</ul>
</li>
<li>Nginx优点<ul>
<li>轻量级<ul>
<li>功能模块少（源代码仅保留http与核心模块代码,其余不够核心代码会作为插件来安装）</li>
<li>代码模块化（易读，便于二次开发，对于开发人员非常友好）</li>
</ul>
</li>
<li>技术成熟，国内公司基本大规模使用<ul>
<li>适合当前主流架构趋势，微服务、云架构、中间层</li>
<li>统一技术栈，降低维护成本，降低技术更新成本</li>
</ul>
</li>
<li>Nginx采用Epoll网络模型，Apache 采用select模型<ul>
<li>select：当用户发起一次请求，select模型就会进行一次遍历扫描， 从而导致性能低下</li>
<li>Epoll：当用户发起请求，epool模型会直接进行处理，效率高效，并无连接限制</li>
</ul>
</li>
</ul>
</li>
<li>常用的HTTP Web服务<ul>
<li>Httpd——Apache基金会</li>
<li>IIS——微软服务器版</li>
<li>GWS——Google开发</li>
<li>Openrestry——基于Nginx+lua</li>
<li>Tengline——淘宝基于Nginx开发</li>
</ul>
</li>
</ul>
<h1 id="2-Nginx应用场景"><a href="#2-Nginx应用场景" class="headerlink" title="2 Nginx应用场景"></a>2 Nginx应用场景</h1><p><img src="1575686992791.png" alt="1575686992791"></p>
<h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><ul>
<li>正向代理：在客户端(浏览器)配置代理服务器，通过代理服务器进行互联网访问</li>
</ul>
<p><img src="1575687744434.png" alt="1575687744434"></p>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><ul>
<li><p>我们只需要将请求发送到反向代理服务器，由反向代理服务器去选择目标服务器获取数据<br>返回给客户端，此时反向代理服务器和目标服务器对外就是一个服务器， 暴露的是<br>代理服务器地址,隐藏了真实服务器IP地址</p>
<p><img src="1588901698779.png" alt="1588901698779"></p>
</li>
</ul>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><ul>
<li><p>增加服务器的数量，然后将请求分发到各个服务器上，将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分发到不同的服务器。</p>
<p><img src="1588902037728.png" alt="1588902037728"></p>
</li>
</ul>
<h3 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h3><ul>
<li><p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度。降低原来单个服务器的压力。</p>
<p><img src="1588903187825.png" alt="1588903187825"></p>
</li>
</ul>
<h2 id="Nginx安装方式"><a href="#Nginx安装方式" class="headerlink" title="Nginx安装方式"></a>Nginx安装方式</h2><ul>
<li><p>官方源 ——官方编译好的，封装成rpm包，并提供yum源【推荐】</p>
<ul>
<li><p>nginx.org 官网有详细过程[<a href="http://nginx.org/en/download.html]" target="_blank" rel="noopener">http://nginx.org/en/download.html]</a></p>
</li>
<li><p>配置Nginx官方yum仓库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class="line">    [nginx]</span><br><span class="line">    name=nginx repo</span><br><span class="line">    baseurl=http://nginx.org/packages/centos/7/$basearch/</span><br><span class="line">    gpgcheck=0</span><br><span class="line">    enabled=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装nginx，必须安装官方源的nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 ~]# yum install -y nginx</span><br><span class="line">[root@web01 ~]# nginx -v			# 查询是否成功</span><br><span class="line">    nginx version: nginx/1.14.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问网址 查询是否成功</p>
</li>
</ul>
</li>
<li><p>EPEL源——版本低，功能少</p>
</li>
<li><p>源代码——自己下载源代码，安装复杂，费时</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果企业之前的Nginx都是通过源码安装，这时需要我们部署新的Nginx服务器，怎么接手通过源代码方式安装</span><br><span class="line">通过nginx -v			获得版本</span><br><span class="line">通过nginx -V			查看配置选项</span><br></pre></td></tr></table></figure>



<h2 id="Nginx常用命令"><a href="#Nginx常用命令" class="headerlink" title="Nginx常用命令"></a>Nginx常用命令</h2><ul>
<li><p>查看nginx的版本号    </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s stop</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新加载nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件语法检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>  ​    </p>
<h2 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h2><ul>
<li>Nginx主配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>Cgi、Fastcgi、 Uwcgi配置文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;fastcgi_params</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;scgi_params</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;uwsgi_params</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx编码转换映射文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;win-utf</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;koi-utf</span><br><span class="line">&#x2F;etc&#x2F;nginx&#x2F;koi-win</span><br></pre></td></tr></table></figure>

<ul>
<li>http协议的Content-Type与扩展名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;mime.types</span><br></pre></td></tr></table></figure>

<ul>
<li>配置系统守护进程管理器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;1ib&#x2F;systemd&#x2F;system&#x2F;nginx.service</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx日志轮询，日志切割</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;logrotate.d&#x2F;nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx终端管理命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;sbin&#x2F;nginx</span><br><span class="line">&#x2F;usr&#x2F;sbin&#x2F;nginx-debug</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx模块目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;modules</span><br><span class="line">&#x2F;usr&#x2F;1ib64&#x2F;nginx</span><br><span class="line">&#x2F;usr&#x2F;1ib64&#x2F;nginx&#x2F;modules</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx默认站点目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;50x.html</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;index.html</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx的帮助手册</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx-1.14.0</span><br><span class="line">&#x2F;usr&#x2F;share&#x2F;man&#x2F;man8&#x2F;nginx.8.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx的缓存目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;cache&#x2F;nginx</span><br></pre></td></tr></table></figure>

<ul>
<li>Nginx的日志目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;log&#x2F;nginx</span><br></pre></td></tr></table></figure>



<h2 id="Nginx主配置文件"><a href="#Nginx主配置文件" class="headerlink" title="Nginx主配置文件"></a>Nginx主配置文件</h2><ul>
<li><p><code>nginx.conf</code>是一个纯文本类型的文件，整个配置文件是以区块的形式组织的。每个区块以一对大括号{}来表示开始与结束</p>
<p><img src="1575703052492.png" alt="1575703052492"></p>
</li>
</ul>
<h3 id="CoreModule核心模块"><a href="#CoreModule核心模块" class="headerlink" title="CoreModule核心模块"></a>CoreModule核心模块</h3><ul>
<li>从<strong>配置文件开始</strong>到<strong>events块</strong>之间的内容</li>
<li>主要会<strong>设置一些影响nginx服务器整体运行的配置指令</strong>，主要包括配置运行Nginx服务器的用户(组)、允许生成的worker process数，进程PID存放路径、日志存放路径和类型以及配置文件的引入等。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user nginx;							#Nginx进程所使用的用户</span><br><span class="line">worker_processes 1;					#Nginx运行的work进程数量(建议与CPU数量一致或auto)</span><br><span class="line">error_log &#x2F;1og&#x2F;nginx&#x2F;error.1og; 		#Nginx错误日志存放路径</span><br><span class="line">pid &#x2F;var&#x2F;run&#x2F;nginx.pid;				#Nginx服务运行后产生的pid进程号</span><br></pre></td></tr></table></figure>



<h3 id="EventModule-事件驱动模块"><a href="#EventModule-事件驱动模块" class="headerlink" title="EventModule    事件驱动模块"></a>EventModule    事件驱动模块</h3><ul>
<li><p>影响Nginx服务器与用户的网络连接</p>
</li>
<li><p>常用的设置包括是否开启对多work process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个word process可以同时支持的最大连接数等。</p>
</li>
<li><p><strong>对Nginx的性能影响较大，在实际中应该灵活配置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">events &#123;</span><br><span class="line">    worker_connections	 	1024;		#每个worker进程支持的最大连接数</span><br><span class="line">    use epool;							#事件驱动模型，epoll默认</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h3 id="HttpCoreModule-http内核模块"><a href="#HttpCoreModule-http内核模块" class="headerlink" title="HttpCoreModule http内核模块"></a>HttpCoreModule http内核模块</h3><ul>
<li><p>Nginx服务器配置中最频繁的部分，代理、缓存和日志定义等绝大多数功能和第三方模块的配置都在这里。</p>
</li>
<li><p>http内核模块</p>
<ul>
<li>http全局块</li>
<li>server 块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">http &#123; </span><br><span class="line"><span class="meta">	#</span><span class="bash"> http全局块</span></span><br><span class="line">    ...</span><br><span class="line"><span class="meta">	#</span><span class="bash">使用server配置网站，每个Server&#123;&#125;代表一个网站(简称虛拟主机)</span></span><br><span class="line">	server&#123;</span><br><span class="line">		listen	80;					#监听端口，默认80</span><br><span class="line">		server_name	localhost; 		#提供服务的域名或主机名</span><br><span class="line">		access_log host.access.1og  #访问日志</span><br><span class="line"><span class="meta">		#</span><span class="bash">控制网站访问路径</span></span><br><span class="line">		location / &#123;</span><br><span class="line">			root	/usr/share/nginx/html; //存放网站 代码路径</span><br><span class="line">			index index.php index.html index.htm;</span><br><span class="line">		//服务器返回的默认页面文件</span><br><span class="line">		//指定错误代码，统一定义错误页面，错误代码重定向到新的Locaiton</span><br><span class="line">		error_page	500 502 503 504 /50x.html;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="meta">	#</span><span class="bash">第二个虚拟主机配置</span></span><br><span class="line">	server&#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	include /etc/nginx/conf.d/*.conf; 	#其他附加配置文件</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="http全局块"><a href="#http全局块" class="headerlink" title="http全局块"></a>http全局块</h4><ul>
<li>http全局块配置的指令包括文件引入、MIME-TYPE 定义、日志自定义、连接超时时间、单链接请求数上限等。</li>
</ul>
<h4 id="server-块"><a href="#server-块" class="headerlink" title="server 块"></a>server 块</h4><ul>
<li><p>HTTP模块层允许有多个Server块  Server主要 用于配置多个网站</p>
</li>
<li><p>Server块又允许有多个Location Location主要用于定义网站访问路径</p>
<p><img src="1575703252359.png" alt="1575703252359"></p>
</li>
</ul>
<h4 id="location指令详解"><a href="#location指令详解" class="headerlink" title="location指令详解"></a>location指令详解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location [ &#x3D; | ~ | ~* | ^~ ] uri&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>没有修饰符：必须以指定模式开始，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">　　server_name baidu.com;</span><br><span class="line">　　location &#x2F;abc &#123;</span><br><span class="line">　　　　……</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">那么，如下是对的：</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc?p1</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abcde</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>=</code>：用于不含正则表达式的uri前，要求请求字符串与uri严格匹配，如果匹配成功，就停止继续向下搜索并立即处理该请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">server_name sish</span><br><span class="line">　　location &#x3D; &#x2F;abc &#123;</span><br><span class="line">　　　　……</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br><span class="line">那么，如下是对的：</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc?p1</span><br><span class="line">如下是错的：</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abcde</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>~</code> ： 用于表示uri包含正则表达式，并且区分大小写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    server_name baidu.com;</span><br><span class="line">    location ~^ &#x2F;abc$ &#123;</span><br><span class="line">        ……</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">那么，如下是对的：</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc?p1&#x3D;11&amp;p2&#x3D;22</span><br><span class="line">如下是错的：</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;ABC</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abcde</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>~*</code>：用于表示uri包含正则表达式，并且不区分大小写。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">server_name baidu.com;</span><br><span class="line">location ~* ^&#x2F;abc$ &#123;</span><br><span class="line">　　　　……</span><br><span class="line">　　&#125;</span><br><span class="line">&#125;</span><br><span class="line">那么，如下是对的：</span><br><span class="line">http:&#x2F;&#x2F;baidu.com&#x2F;abc</span><br><span class="line">http:&#x2F;&#x2F;baidu..com&#x2F;ABC</span><br><span class="line">http:&#x2F;&#x2F;baidu..com&#x2F;abc?p1&#x3D;11&amp;p2&#x3D;22</span><br><span class="line">如下是错的：</span><br><span class="line">http:&#x2F;&#x2F;baidu..com&#x2F;abc&#x2F;</span><br><span class="line">http:&#x2F;&#x2F;baidu..com&#x2F;abcde</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>^~</code>：用于不含正则表达式的 uri前，无修饰符的行为，也是以指定模式开始，不同的是，如果模式匹配，那么就停止搜索其他模式了。</p>
</li>
<li><p>注意：如果uri包含正则表达式，则必须要有<code>~</code>或者<code>~*</code>标识</p>
</li>
</ul>
<h4 id="root-amp-alias指令区别"><a href="#root-amp-alias指令区别" class="headerlink" title="root &amp; alias指令区别"></a><strong>root &amp; alias指令区别</strong></h4><ul>
<li><p><strong>alias是一个目录别名的定义，root则是最上层目录的定义。</strong></p>
</li>
<li><p>若按照上述配置的话，则访问/img/目录里面的文件时，ningx会自动去/var/www/image/目录找文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;img&#x2F; &#123;</span><br><span class="line">    alias &#x2F;var&#x2F;www&#x2F;image&#x2F;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>#若按照这种配置的话，则访问/img/目录下的文件时，nginx会去/var/www/image/img/目录下找文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;img&#x2F; &#123;</span><br><span class="line">    root &#x2F;var&#x2F;www&#x2F;image;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>还有一个重要的区别是alias后面必须要用“/”结束，否则会找不到文件，而root则可有可无</p>
</li>
</ul>
<h2 id="Nginx搭建Web服务器"><a href="#Nginx搭建Web服务器" class="headerlink" title="Nginx搭建Web服务器"></a>Nginx搭建Web服务器</h2><ul>
<li><strong>Nginx可以作为静态页面的web服务器</strong>，同时还支持CGI协议的动态语言，比如perl、php等。但是<strong>不支持Java，Java程序只能通过与tomcat配合完成</strong></li>
</ul>
<ul>
<li><p>Nginx配置Web服务器网站【功能同Apache的Tomcat】——接收客户请求端请求，并响应</p>
<ul>
<li>功能：当我们访问game.oldboy.com的时候，访问/oldboy_code/里面的页面代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name yangyuxin.top;</span><br><span class="line">    index index.php index.html index.htm default.php default.htm default.html;</span><br><span class="line">    root &#x2F;www&#x2F;wwwroot&#x2F;yangyuxin.top;		# 静态页面所在目录</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h2 id="Nginx反向代理"><a href="#Nginx反向代理" class="headerlink" title="Nginx反向代理"></a>Nginx反向代理</h2><ul>
<li><p>功能：使用Nginx从<strong>80端口跳转到8080端口</strong>的Tomcat主页</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name yangyuxin.top;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">          root html;</span><br><span class="line">          proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;			&#x2F;&#x2F;⭐</span><br><span class="line">          index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>功能：使用 nginx 反向代理，根据访问的路径跳转到不同端口的服务中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name yangyuxin.top;</span><br><span class="line">        location ~/hello/ &#123;</span><br><span class="line">          root html;</span><br><span class="line">          proxy_pass http://127.0.0.1:8080;</span><br><span class="line">          index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~/world/ &#123;</span><br><span class="line">          root html;</span><br><span class="line">          proxy_pass http://127.0.0.1:8081;</span><br><span class="line">          index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="1588928819346.png" alt="1588928819346"></p>
<p><img src="1588928842462.png" alt="1588928842462"></p>
</li>
</ul>
<h2 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h2><ul>
<li><p>实现效果：浏览器地址栏输入地址负载均衡，按比例均衡到8080和8081端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">upstream myservername&#123;							&#x2F;&#x2F;⭐</span><br><span class="line">    # ip_hash		&#x2F;&#x2F; 每个请求按访问ip的hash结果分配，访客固定访问一个后端服务器,可以解决session的问题。</span><br><span class="line">    server 47.92.38.57:8080 weight&#x3D;2; 			&#x2F;&#x2F;⭐</span><br><span class="line">    server 47.92.38.57:8081 weight&#x3D;4;	    	&#x2F;&#x2F;⭐</span><br><span class="line">    # fair			&#x2F;&#x2F; 按后端服务器的响应时间来分配请求，响应时间短的优先分配。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name yangyuxin.top;</span><br><span class="line">        location ~&#x2F;hello&#x2F; &#123;</span><br><span class="line">          root html;</span><br><span class="line">          proxy_pass http:&#x2F;&#x2F;myservername;		&#x2F;&#x2F;⭐</span><br><span class="line">          index index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





</li>
</ul>
<h2 id="Nginx高可用"><a href="#Nginx高可用" class="headerlink" title="Nginx高可用"></a>Nginx高可用</h2><p><img src="1588955148812.png" alt="1588955148812"></p>
<ul>
<li>准备<ul>
<li>两台nginx服务器</li>
<li>分别安装keepalived</li>
<li>虚拟ip</li>
</ul>
</li>
</ul>
<h3 id="Keepalived实现高可用"><a href="#Keepalived实现高可用" class="headerlink" title="Keepalived实现高可用"></a>Keepalived实现高可用</h3><ul>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived -y</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装之后，在<code>etc</code>里面生成目录<code>keepalived</code>, 有文件<code>keepalived.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;					# 全局配置</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL			# ⭐通过这个名字可以访问主机&#x2F;服务器 &#x2F;etc&#x2F;hosts文件下配置这个名字</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line">vrrp_script chk_http_port &#123;		# 脚本配置</span><br><span class="line">	script &quot;&#x2F;usr&#x2F;local&#x2F;src&#x2F;nginx_check.sh&quot;</span><br><span class="line">	interval 2				#(检测脚本执行的间隔)</span><br><span class="line">	weight 2				# 设置当前服务器权重</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;		# 虚拟IP配置</span><br><span class="line">    state MASTER			# 备份服务器改为BACKUP</span><br><span class="line">    interface eth0			# 网卡</span><br><span class="line">    virtual_router_id 51	# 主、备机的virtual_ router_ id必须相同	</span><br><span class="line">    priority 100			#主、备机取不同的优先级，主机值较大，备份机值较小</span><br><span class="line">    advert_int 1			# 心跳时间</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.16		#VRRP H虚拟IP</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>检测脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;bash</span><br><span class="line">A&#x3D; &#96;ps -C nginx -no-header| wc -l&#96;</span><br><span class="line">if [ $A -eq 0 ];then</span><br><span class="line">	&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;sbin&#x2F;nginx</span><br><span class="line">	sleep 2</span><br><span class="line">	if [&#96;ps -C nginx --no-header| wc -l&#96; -eq 0];</span><br><span class="line">		killall keepalived</span><br><span class="line">    fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</li>
<li><p>把两台服务器上nginx和keepalived启动。</p>
<ul>
<li><p>启动nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>启动keepalived</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start keepalived.services</span><br></pre></td></tr></table></figure>







</li>
</ul>
</li>
</ul>
<h2 id="Nginx目录索引模块"><a href="#Nginx目录索引模块" class="headerlink" title="Nginx目录索引模块"></a>Nginx目录索引模块</h2><ul>
<li><p>官方文档使用说明</p>
<p><img src="1575780742140.png" alt="1575780742140"></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Nginx 默认是不允许列出整个目录浏览下载</span><br><span class="line">Syntax: autoindex on | off;</span><br><span class="line">Default: autoindex off;</span><br><span class="line">Context: http, server, location</span><br><span class="line"></span><br><span class="line"># autoindex常用参数</span><br><span class="line">autoindex_exact_size off;		# 默认为on 显示出文件的确切大小 单位是bytes</span><br><span class="line">								# 修改为off 显示出文件的大概大小 单位是kB或者MB或者GB</span><br><span class="line">autoindex_localtime on;			# 默认为off 显示的文件时间为GMT时间</span><br><span class="line">								# 修改为on 显示的文件时间为文件的服务器时间</span><br><span class="line">charset utf-8,gbk;				# 默认中文目录乱码 添加解决乱码</span><br></pre></td></tr></table></figure>

<ul>
<li><p>访问game.oldboy.com/download，打开目录索引列表</p>
<ul>
<li>在配置文件中添加</li>
</ul>
<p><img src="1575783147690.png" alt="1575783147690"></p>
<p><img src="1575785803803.png" alt="1575785803803"></p>
</li>
</ul>
<h2 id="Nginx状态监控模块"><a href="#Nginx状态监控模块" class="headerlink" title="Nginx状态监控模块"></a>Nginx状态监控模块</h2><ul>
<li><p>ngx_http_stub_status_module用于展示Nginx连接状态信息</p>
<ul>
<li><p>需要–with-http_stub_status_module配置参数启用【nginx -V 查看】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Syntax:		stub_status;</span><br><span class="line">Default:	—</span><br><span class="line">Context:    server, location</span><br><span class="line"></span><br><span class="line">注意:</span><br><span class="line">- 如果使用restart重置服务，会清空所有的连接数</span><br><span class="line">- reload重载不会清空之前的连接数</span><br><span class="line">- 通过状态监控，可以区分长连接和短连接</span><br><span class="line">	vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf	#修改下面参数</span><br><span class="line">		keepalive_timeout 0; 		#将长连接变为短连接</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><img src="1575786624450.png" alt="1575786624450"></p>
<p><img src="1575785770881.png" alt="1575785770881"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Active connections 		# 当前活动的连接数</span><br><span class="line">accepts	4				# 当前的总连接数TCP</span><br><span class="line">handled	4				# 成功的连接数TCP</span><br><span class="line">requests 61				# 总的http请求数</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="Nginx访问控制"><a href="#Nginx访问控制" class="headerlink" title="Nginx访问控制"></a>Nginx访问控制</h2><ul>
<li><p>访问控制分类</p>
<ul>
<li><p>基于IP的访问控制http_access_modul</p>
<ul>
<li>只允许10.0.0.1访问nginx_status,其他都拒绝</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">应用——网站后台</span><br><span class="line"></span><br><span class="line"># 从上往下依次匹配 满足则停止</span><br><span class="line"># 允许配置语法</span><br><span class="line">Syntax:	allow address | CIDR | unix: | all;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location, limit_except</span><br><span class="line"># 拒绝配置语法</span><br><span class="line">Syntax:	deny address | CIDR | unix: | all;</span><br><span class="line">Default:	—</span><br><span class="line">Context: http, server, location, limit_except</span><br></pre></td></tr></table></figure>

<p><img src="1575791192758.png" alt="1575791192758"></p>
</li>
<li><p>基于用户登陆认证http_auth_basic_module</p>
<ul>
<li>身份认证后才可以登录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;配置语法</span><br><span class="line">Syntax: 	auth_basic string | off;</span><br><span class="line">Default:	auth_basic off;</span><br><span class="line">Context:	http, server, location, limit_except</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;配置语法 用户密码记录配置文件</span><br><span class="line">Syntax: 	auth_basic_user_file file;</span><br><span class="line">Default:	-</span><br><span class="line">Context:	http，server, location, limit_except</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;需要安装依赖组件</span><br><span class="line">[root@web01 ~]# yum install httpd-too1s</span><br><span class="line">[root@web01 ~]# htpasswd -b -c &#x2F;etc&#x2F;nginx&#x2F;.auth_conf username 123456</span><br></pre></td></tr></table></figure>

<p><img src="1575794573505.png" alt="1575794573505"></p>
</li>
</ul>
</li>
</ul>
<h2 id="Nginx访问限制"><a href="#Nginx访问限制" class="headerlink" title="Nginx访问限制"></a>Nginx访问限制</h2><ul>
<li>经常会遇到这种情况， 服务器流量异常，负载过大等等。</li>
<li>对于大流量恶意的攻击访问，会带来带宽的浪费， 服务器压力，影响业务，往往考虑对同一个IP的连接数，并发数进行限制</li>
<li>ngx_http_limit_conn_module 模块可以根据定义的key来限制每个键值的连接数，如同一个IP来源的连接数</li>
</ul>
<h3 id="limit-conn-module连接频率限制"><a href="#limit-conn-module连接频率限制" class="headerlink" title="limit_conn_module连接频率限制"></a>limit_conn_module连接频率限制</h3><ul>
<li>同一IP同一时间只允许有一个连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$binary_remote_addr 变量的长度是固定的4字节</span><br><span class="line">$remote_addr		变量的长度是7-15字节</span><br><span class="line"></span><br><span class="line">Syntax: limit_conn_zone key zone&#x3D;name:size;</span><br><span class="line">Default: -</span><br><span class="line">Context: http;</span><br><span class="line"></span><br><span class="line">Syntax:	limit_conn zone number;</span><br><span class="line">Default: —</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;压力测试</span><br><span class="line">yum install -y httpd-tools</span><br><span class="line">ab -n 50 -c 20 http:&#x2F;&#x2F;127.0.0.1&#x2F;index.html	# 一次50个请求 20个并发</span><br></pre></td></tr></table></figure>

<p><img src="1575797185873.png" alt="1575797185873"></p>
<h3 id="limit-req-module请求频率限制"><a href="#limit-req-module请求频率限制" class="headerlink" title="limit_req_module请求频率限制"></a>limit_req_module请求频率限制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_req_zone key zone&#x3D;name:size rate&#x3D;rate;</span><br><span class="line">Default: -</span><br><span class="line">Context: http</span><br><span class="line"></span><br><span class="line">Syntax:	limit_req zone&#x3D;name [burst&#x3D;number] [nodelay | delay&#x3D;number];</span><br><span class="line">Default:	—</span><br><span class="line">Context:	http, server, location </span><br><span class="line"></span><br><span class="line">Syntax: limit_req_status code;</span><br><span class="line">Default: 503</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">定义的区域名称为req_zone（zone&#x3D;req_zone） 分配内存大小为10m（如果限制域的存储空间耗尽了 对于后续所有请求 服务器都会返回503） </span><br><span class="line">同一个ip（$binary_remote_addr）平均处理的请求频率不能超过每秒1次（rate&#x3D;1r&#x2F;s）； 如果超过每秒1次但超过的请求数量小于等于3（burst&#x3D;3）时，会延迟请求。</span><br><span class="line">如果超过每秒1次的请求数超过3，则立即返回503（limit_req_status 503）给客户端</span><br></pre></td></tr></table></figure>

<p><img src="1575799641241.png" alt="1575799641241"></p>
<h3 id="请求-连接限制对比"><a href="#请求-连接限制对比" class="headerlink" title="请求/连接限制对比"></a>请求/连接限制对比</h3><ul>
<li>多个请求可以建立在一次的TCP连接之上，那么我们对请求的精度限制，当然比对一个连接的限制会更加的有效，因为同- -时刻只允许一个连接请求进入。但是同一 时刻多个请求可以通过一个 连接进入。所以<strong>请求限制才是比较优的解决方案</strong></li>
</ul>
<h1 id="Nginx原理"><a href="#Nginx原理" class="headerlink" title="Nginx原理"></a>Nginx原理</h1><ul>
<li><p><code>master &amp; worker</code></p>
<ul>
<li>master进程主要负责对外接收客户端的请求，并将活儿合理的分配给多个worker，每个worker进程主要负责处理请求。</li>
</ul>
<p><img src="1589002067112.png" alt="1589002067112"></p>
<p><img src="1589002116526.png" alt="1589002116526"></p>
</li>
<li><p><code>master-workers</code>的机制的优点</p>
<ul>
<li>可以使用 <code>nginx –s reload</code>热部署，利用 nginx进行热部署操作</li>
<li>每个worker进程是独立的进程，不需要加锁，节省锁带来的开销。</li>
<li>每个worker进程互相之间不会影响，一个进程退出后，其它进程还在工作，服务不会中断，master 进程则很快启动新的worker进程。</li>
</ul>
</li>
<li><p>设置多少个 woker 合适</p>
<ul>
<li>Nginx同redis类似都采用了io 多路复用机制，每个worker都是一个独立的进程， 但每个进程里只有一个主线程，通过异步非阻塞的方式来处理请求，即使是千上万个请求也不在话下。每个worker的线程可以把一个cpu的性能发挥到极致。所以<strong>worker数和服务器的cpu数相等是最为适宜的</strong>。设少了会浪费qpu，设多了会造成cgpu频繁切换上下文带来的损耗。</li>
</ul>
<p><img src="1589002735126.png" alt="1589002735126"></p>
</li>
<li><p>发送请求，占用了 woker 的几个连接数？</p>
<ul>
<li><p>从用户的角度，http 1.1协议下，由于浏览器默认使用两个并发连接,因此计算方法：</p>
<ul>
<li>nginx作为http服务器的时候</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_clients &#x3D; worker_processes * worker_connections&#x2F;2</span><br></pre></td></tr></table></figure>

<ul>
<li>nginx作为反向代理服务器的时候：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_clients &#x3D; worker_processes * worker_connections&#x2F;4</span><br></pre></td></tr></table></figure>
</li>
<li><p>从一般建立连接的角度：客户并发连接为1.</p>
<ul>
<li><p>nginx作为http服务器的时候：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_clients &#x3D; worker_processes * worker_connections</span><br></pre></td></tr></table></figure>
</li>
<li><p>nginx作为反向代理服务器的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">max_clients &#x3D; worker_processes * worker_connections&#x2F;2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nginx做反向代理时，和客户端之间保持一个连接，和后端服务器保持一个连接。  </p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div><div class="post-copyright"><blockquote><p>原文作者: 掘金木匠</p><p>原文链接: <a href="http://goldcarpenter.github.io/2020/03/29/Nginx基础/">http://goldcarpenter.github.io/2020/03/29/Nginx基础/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/Nginx/">Nginx</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2020/04/04/Redis_Part2/" class="pre">Redis</a><a href="/2020/03/26/Redis_Part1/" class="next">Redis</a></div><div id="comments"><div id="SOHUCS" sid="2020/03/29/Nginx基础/"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx"><span class="toc-text">Nginx</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Nginx简介"><span class="toc-text">1 Nginx简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Nginx应用场景"><span class="toc-text">2 Nginx应用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#正向代理"><span class="toc-text">正向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#反向代理"><span class="toc-text">反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#负载均衡"><span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动静分离"><span class="toc-text">动静分离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx安装方式"><span class="toc-text">Nginx安装方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx常用命令"><span class="toc-text">Nginx常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx配置文件"><span class="toc-text">Nginx配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx主配置文件"><span class="toc-text">Nginx主配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CoreModule核心模块"><span class="toc-text">CoreModule核心模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EventModule-事件驱动模块"><span class="toc-text">EventModule    事件驱动模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HttpCoreModule-http内核模块"><span class="toc-text">HttpCoreModule http内核模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http全局块"><span class="toc-text">http全局块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server-块"><span class="toc-text">server 块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#location指令详解"><span class="toc-text">location指令详解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#root-amp-alias指令区别"><span class="toc-text">root &amp; alias指令区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx搭建Web服务器"><span class="toc-text">Nginx搭建Web服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx反向代理"><span class="toc-text">Nginx反向代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx负载均衡"><span class="toc-text">Nginx负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx高可用"><span class="toc-text">Nginx高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived实现高可用"><span class="toc-text">Keepalived实现高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx目录索引模块"><span class="toc-text">Nginx目录索引模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx状态监控模块"><span class="toc-text">Nginx状态监控模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx访问控制"><span class="toc-text">Nginx访问控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx访问限制"><span class="toc-text">Nginx访问限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-conn-module连接频率限制"><span class="toc-text">limit_conn_module连接频率限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit-req-module请求频率限制"><span class="toc-text">limit_req_module请求频率限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求-连接限制对比"><span class="toc-text">请求&#x2F;连接限制对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx原理"><span class="toc-text">Nginx原理</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/17/Redis_Part3/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/04/Redis_Part2/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/29/Nginx%E5%9F%BA%E7%A1%80/">Nginx</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/26/Redis_Part1/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/29/jdk8%E6%96%B0%E7%89%B9%E6%80%A7_Part3/">JDK8新特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/29/jdk8%E6%96%B0%E7%89%B9%E6%80%A7_Part2/">JDK8新特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/25/jdk8%E6%96%B0%E7%89%B9%E6%80%A7_Part1/">JDK8新特性</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/02/javaIO/">JavaIO</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/21/ThreadLocal/">ThreadLocal总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/19/SpringMVC_Part3/">SpringMVC</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Debug%E8%AE%B0%E5%BD%95/">Debug记录</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E9%AB%98%E7%BA%A7/">Java高级</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL%E5%9F%BA%E7%A1%80/">MySQL基础</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%BC%80%E5%8F%91/">Web开发</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">博客搭建</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 15px;">注解</a> <a href="/tags/String/" style="font-size: 15px;">String</a> <a href="/tags/%E5%86%85%E9%83%A8%E7%B1%BB/" style="font-size: 15px;">内部类</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/ThreadLocal/" style="font-size: 15px;">ThreadLocal</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">多线程</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/IEDA/" style="font-size: 15px;">IEDA</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/SpringMVC/" style="font-size: 15px;">SpringMVC</a> <a href="/tags/MyBatis/" style="font-size: 15px;">MyBatis</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">34</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.scu.edu.cn/" title="四川大学首页" target="_blank">四川大学首页</a><ul></ul><a href="http://www.scu.edu.cn/" title="个人项目——待完善" target="_blank">个人项目——待完善</a><ul></ul><a href="http://www.scu.edu.cn/" title="个人项目——待完善" target="_blank">个人项目——待完善</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">掘金木匠.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script>window._config = { showScore: true };
(function(){ 
  var appid = 'cyuBR2wWE'; 
  var conf = 'cbd82aee65d05c481319a299102b4811'; 
  var width = window.innerWidth || document.documentElement.clientWidth; 
  var nodes =document.getElementsByTagName("head")[0]||document.head||document.documentElement;
  if (/(Android|iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent) && width < 750) {  
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>');
  }
  else { 
    var loadJs=function(d,a){
      var b=document.createElement("script");b.setAttribute("type","text/javascript");
      b.setAttribute("charset","UTF-8");
      b.setAttribute("src",d);
      if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}
      nodes.appendChild(b)
    };
    loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); 
  } 
  var loadCss = function(cssString){  
    var style=document.createElement("style");  
    style.setAttribute("type", "text/css");  
    if(style.styleSheet){// IE  
        style.styleSheet.cssText = cssString;  
    } else {// w3c  
        var cssText = document.createTextNode(cssString);  
        style.appendChild(cssText);  
    }
    nodes.appendChild(style);
  }
  //- window.onload=function(){
  //-   if(window.outerWidth<=775){
  //-     loadCss('.module-hot-topic,.module-cmt-float-bar{display:none!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .cbox-prompt-w span.prompt-empty-w,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w .form-text-w span.text-null,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w a.comment-link-w,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w span.comment-text-w,#SOHUCS #SOHU_MAIN .module-cmt-footer .section-service-w div.service-wrap-w a:hover,#SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login,#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w span.wrap-name-w,#SOHUCS #SOHU_MAIN .module-cmt-list .action-click-gw span.click-disable-eg a em.icon-name-bg,#SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li div.title-name-gw,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number .comment-number span.cy-number,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number span.comment-number,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active,#SOHUCS #SOHU_MAIN .module-cmt-list .msg-wrap-gw .wrap-action-gw .action-click-gw span a:hover,#SOHUCS #SOHU_MAIN .module-cmt-list .picture-box-gw div.box-action-gw a:hover,#SOHUCS #SOHU_MAIN .module-cmt-list .wrap-action-gw .action-click-gw span a:hover em.icon-name-bg,#SOHUCS #SOHU_MAIN .module-cmt-list .wrap-user-gw span.user-name-gw a{color:#40759b!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-r,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-l,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-r{display:none!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-l{background:#FFF!important;top:-2px!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-function-w .uploading-wrapper-dw div.wrapper-image-dw,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-main,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w div.form-text-w,#SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login,#SOHUCS #SOHU_MAIN .module-cmt-list .module-cmt-box .post-wrap-w div.post-wrap-main{border:1px solid #e6e6e6!important;border-radius:20px 20px 20px 20px;margin:0!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw{width:130px!important;height:34px!important;line-height:33px!important;font-size:17px!important;background:#5483b1!important;border-radius:20px!important;color:#FFF!important;-webkit-box-shadow:0 -1px 4px #5483b1 inset;box-shadow:0 -1px 10px #5483b1 inset}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw:before{content:"发表评论"}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a:hover .btn-fw{color:#40759b!important;background:#FFF!important}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li{background:none!important;border-bottom:1px solid #e6e6e6}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active{border:1px solid #e6e6e6;border-radius:10px 10px 0 0;border-bottom:none}#SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li .title-name-gw div.title-name-gw-tag{background:#5483b1!important;border-radius:3px}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type div.cmt-list-border{background-color:#e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item{border:1px solid #e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo{text-align:center;line-height:40px;border-radius:50%!important;background:#e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo:before{content:"畅";font-size:22px;color:#FFF}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text,#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text i{color:#5483b1!important}#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w{background:#FFF!important}@media screen and (min-width:900px){#SOHUCS #SOHU_MAIN .module-mobile-cmt-list .list-wrapper-wap .list-container-wap .list-item-wap .list-content-wrapper-wap .cmt-list-image-container .cmt-list-image{max-width: 100%;}}');
  //-   }
  //- };
})();
function removeElement(_element){
     var _parentElement = _element.parentNode;
     if(_parentElement){
            _parentElement.removeChild(_element);
     }
}
var removeAD = document.createElement("div");
removeAD.id = 'removeAD';
var adInterval1 = setInterval(function() {
  if(document.querySelector("#feedAv")){
    document.querySelector("[node-type=cmt-list]").appendChild(removeAD);
    document.querySelector("#removeAD").appendChild(document.querySelector("#feedAv"));
    //- removeElement(document.querySelectorAll("#feedAv")[0]);
    var feedAv = document.querySelector("#feedAv").children;
    for( item of feedAv){
      item.style.display = 'none'
    }
    document.querySelector("#removeAD").style.display="none"
    clearInterval(adInterval1);
  }
},1000);
var adInterval2 = setInterval(function() {
  if(document.querySelector("#pop_ad")){
    removeElement(document.querySelector("#pop_ad"));
    clearInterval(adInterval2);
  }
}, 1000);</script><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script></body></html>