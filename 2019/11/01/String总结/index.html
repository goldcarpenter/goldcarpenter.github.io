<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="JJMJ's blog."><meta name="keywords" content="Java, Spring, MyBatis, åç«¯"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>Stringåº•å±‚æ€»ç»“ | æ˜é‡‘æœ¨åŒ </title><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Stringåº•å±‚æ€»ç»“</h1><a id="logo" href="/.">æ˜é‡‘æœ¨åŒ </a><p class="description">æ‡‚é‡‘èçš„è½¯ä»¶å·¥ç¨‹å¸ˆä¸€å®šæ˜¯ä¸€ä¸ªåˆæ ¼çš„åƒè´§</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="æœç´¢"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Stringåº•å±‚æ€»ç»“</h1><div class="post-meta"><a href="/2019/11/01/String%E6%80%BB%E7%BB%93/#comments" class="comment-count"><i id="changyan_count_unit" data-xid="2019/11/01/Stringæ€»ç»“/"></i>ç•™è¨€,<i id="changyan_parti_unit" data-xid="2019/11/01/Stringæ€»ç»“/"></i>å‚ä¸</a><p><span class="date">Nov 01, 2019</span><span><a href="/categories/Java%E9%AB%98%E7%BA%A7/" class="category">Javaé«˜çº§</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>ç‚¹å‡»</i></i></span></p></div><div class="post-content"><h1 id="Stringåº•å±‚æ€»ç»“"><a href="#Stringåº•å±‚æ€»ç»“" class="headerlink" title="Stringåº•å±‚æ€»ç»“"></a>Stringåº•å±‚æ€»ç»“</h1><h2 id="1-å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼"><a href="#1-å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼" class="headerlink" title="1.å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼"></a>1.å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼</h2><ul>
<li>å­—ç¬¦ä¸²æœ‰å…­ç§åŸºæœ¬çš„åˆ›å»ºæ–¹å¼<ul>
<li>ä½¿ç”¨<code>char[]</code>æ•°ç»„é…åˆ<code>new</code>æ¥åˆ›å»º</li>
<li>ä½¿ç”¨<code>byte[]</code>æ•°ç»„é…åˆ<code>new</code>æ¥åˆ›å»º</li>
<li>ä½¿ç”¨<code>int[]</code>æ•°ç»„é…åˆ<code>new</code>æ¥åˆ›å»º</li>
<li>ä½¿ç”¨ å·²æœ‰å­—ç¬¦ä¸² é…åˆ<code>new</code>æ¥åˆ›å»º</li>
<li>ä½¿ç”¨å­—é¢é‡åˆ›å»ºï¼ˆä¸ä½¿ç”¨<code>new</code>ï¼‰</li>
<li>åˆäºŒä¸ºä¸€ï¼Œä½¿ç”¨<code>+</code>è¿ç®—ç¬¦æ¥æ‹¼æ¥åˆ›å»º</li>
</ul>
</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè‡³å°‘ä»è¡¨é¢ä¸Šè®²ï¼Œåä¸¤ç§éƒ½æ²¡æœ‰ç”¨åˆ° new å…³é”®å­—</p>
<h3 id="1-1-char-æ•°ç»„åˆ›å»º"><a href="#1-1-char-æ•°ç»„åˆ›å»º" class="headerlink" title="1.1 char[] æ•°ç»„åˆ›å»º"></a>1.1 char[] æ•°ç»„åˆ›å»º</h3><ul>
<li>è¿™ç§æ˜¯æœ€åŸºæœ¬çš„ï¼Œå› ä¸ºå­—ç¬¦ä¸²æœ¬èº«å°±æ˜¯å°†å­—ç¬¦ä¸²èµ·æ¥</li>
<li>Stringåº•å±‚ç»“æ„å°±æ˜¯å¤šä¸ªå­—ç¬¦çš„ char[] æ•°ç»„</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>å®ƒçš„å†…éƒ¨ç»“æ„å¦‚ä¸‹ï¼ˆ1.8ï¼‰</p>
<p><img src="st01-1589963576703.png" alt=""></p>
<p>å…¶ä¸­ 97 å…¶å®å°±æ˜¯ â€˜aâ€™ ï¼Œ98 å…¶å®å°±æ˜¯ â€˜bâ€™ ï¼Œ99 å…¶å®å°±æ˜¯ â€˜câ€™ </p>
<h3 id="1-2-byte-æ•°ç»„åˆ›å»º"><a href="#1-2-byte-æ•°ç»„åˆ›å»º" class="headerlink" title="1.2 byte[] æ•°ç»„åˆ›å»º"></a>1.2 byte[] æ•°ç»„åˆ›å»º</h3><ul>
<li><p>ä»€ä¹ˆæ—¶å€™ä¼šæ ¹æ® byte[] æ•°ç»„æ¥åˆ›å»ºå­—ç¬¦ä¸²å‘¢ã€ä» byte[] è½¬ä¸ºå­—ç¬¦ä¸²çš„éœ€æ±‚ã€‘</p>
<ul>
<li>ä»ç½‘ç»œï¼ˆä¾‹å¦‚ä¸€ä¸ªæµè§ˆå™¨çš„ http è¯·æ±‚ï¼‰ä¼ é€’è¿‡æ¥çš„å­—èŠ‚æ•°æ®</li>
<li>ä» I/Oï¼ˆä¾‹å¦‚ä»ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼‰è¯»å–åˆ°çš„æ•°æ®</li>
</ul>
</li>
<li><p>ä¾‹å¦‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">97</span>, <span class="number">98</span>, <span class="number">99</span>&#125;); <span class="comment">// abc</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>new byte[]{97, 98, 99}</code> å°±å¯ä»¥æ˜¯</p>
<ul>
<li>ä»ç½‘ç»œï¼ˆä¾‹å¦‚ä¸€ä¸ªæµè§ˆå™¨çš„ http è¯·æ±‚ï¼‰ä¼ é€’è¿‡æ¥çš„å­—èŠ‚æ•°æ®</li>
<li>ä» I/Oï¼ˆä¾‹å¦‚ä»ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼‰è¯»å–åˆ°çš„æ•°æ®</li>
</ul>
</li>
<li><p>å®ƒçš„å†…éƒ¨ç»“æ„å…¶å®ä¹Ÿæ˜¯</p>
</li>
</ul>
<p><img src="st01.png" alt=""></p>
<p>è¿™æ—¶ byte[] ä¼šåœ¨æ„é€ æ—¶è¢«è½¬æ¢ä¸º char[]ï¼Œå…¶ä¸­ byte[] å’Œ char [] çš„ç»“æ„å¦‚ä¸‹</p>
<p><img src="st02.png" alt=""></p>
<p>çœ‹åˆ°ä¸Šå¹…å›¾æœ‰åŒå­¦ä¼šè¯´ï¼Œå¯¹äº byte[] è½¬æ¢ä¸º char[]ï¼Œ97 è¿˜æ˜¯å¯¹åº” 97ï¼Œ98 è¿˜æ˜¯å¯¹åº” 98ï¼Œ99 è¿˜æ˜¯å¯¹åº” 99 å•Šï¼Œçœ‹ä¸å‡º byte[] å’Œ char[] çš„ä»»ä½•åŒºåˆ«å•Šï¼Ÿä½ è¦çŸ¥é“ï¼Œé¦–å…ˆä»–ä»¬çš„å¤§å°ä¸ä¸€æ ·ï¼Œå…¶æ¬¡ä¸Šé¢çš„ char[] ä¸­çš„ 97ï¼ˆaï¼‰ï¼Œ98ï¼ˆbï¼‰ï¼Œ99ï¼ˆcï¼‰ éƒ½å±äºæ‹‰ä¸å­—ç¬¦é›†ï¼Œå¦‚æœç”¨åˆ°å…¶å®ƒå­—ç¬¦é›†ï¼Œé‚£ä¹ˆç»“æœå°±ä¸ä¸€æ ·äº†ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­</p>
<ul>
<li><p>æŒ‰ gbk å­—ç¬¦é›†è½¬æ¢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] bytes = &#123;(<span class="keyword">byte</span>) <span class="number">0xD5</span>, (<span class="keyword">byte</span>) <span class="number">0xC5</span>&#125;;</span><br><span class="line">String str = <span class="keyword">new</span> String(bytes, Charset.forName(<span class="string">"gbk"</span>));</span><br><span class="line">System.out.println(str);</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶</p>
</li>
</ul>
<p><img src="st04.png" alt=""></p>
<ul>
<li><p>å…¶ä¸­ä¸¤ä¸ª<code>byte 0xD5</code>å’Œ <code>0xC5</code>è¢«è½¬æ¢æˆäº†ä¸€ä¸ª char 0x5F20ï¼ˆæ±‰å­—ã€å¼ ã€‘ï¼‰</p>
</li>
<li><p>æŒ‰<code>utf-8</code>å­—ç¬¦é›†è½¬æ¢</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">byte</span>[] bytes = &#123;(<span class="keyword">byte</span>) <span class="number">0xE5</span>, (<span class="keyword">byte</span>) <span class="number">0xBC</span>, (<span class="keyword">byte</span>) <span class="number">0xA0</span>&#125;;</span><br><span class="line">      String str = <span class="keyword">new</span> String(bytes, Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line"><span class="comment">//String str = new String(bytes);		ç­‰ä»·</span></span><br><span class="line">      System.out.println(str);</span><br></pre></td></tr></table></figure>

<p><img src="st03.png" alt=""></p>
<p>å…¶ä¸­ä¸‰ä¸ª<code>byte 0xE5</code>ï¼Œ<code>0xBC</code> å’Œ<code>0xA0</code> è¢«è½¬æ¢æˆäº†ä¸€ä¸ª<code>char 0x5F20</code>ï¼ˆæ±‰å­—ã€å¼ ã€‘ï¼‰</p>
<p><strong>å…¶å® java ä¸­çš„ char å­—ç¬¦éƒ½æ˜¯ä»¥ unicode ç¼–ç çš„ï¼Œä»å¤–ç•Œä¸åŒçš„ç¼–ç ï¼ˆå¦‚ gbkï¼Œutf-8ï¼‰ä¼ è¿‡æ¥çš„ byte[] æœ€ç»ˆåˆ° java ä¸­çš„ char éƒ½ç»Ÿä¸€äº†</strong></p>
<h3 id="1-3-int-æ•°ç»„åˆ›å»º"><a href="#1-3-int-æ•°ç»„åˆ›å»º" class="headerlink" title="1.3 int[] æ•°ç»„åˆ›å»º"></a>1.3 int[] æ•°ç»„åˆ›å»º</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦ç”¨ä¸¤ä¸ª char è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œæ¯”å¦‚ ğŸ˜‚ è¿™ä¸ªç¬‘å“­çš„å­—ç¬¦ï¼Œå®ƒç”¨ unicode ç¼–ç è¡¨ç¤ºä¸º 0x1F602ï¼Œå­˜å‚¨èŒƒå›´å·²ç»è¶…è¿‡äº† char èƒ½è¡¨ç¤ºçš„æœ€å¤§å€¼ 0xFFFFï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ int[] æ¥æ„é€ è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0x1F602</span>&#125;, <span class="number">0</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>è½¬æ¢è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</p>
<p><img src="st05.png" alt=""></p>
<blockquote>
<p>å‚è€ƒ</p>
<p><a href="http://unicode.org/versions/Unicode9.0.0/" target="_blank" rel="noopener">unicode 9.0 è¯´æ˜</a></p>
<p><a href="http://www.unicode.org/emoji/charts/emoji-versions.html#v9.0_2016" target="_blank" rel="noopener">unicode ä¸­çš„ emoji è¡¨æƒ…</a></p>
</blockquote>
<h3 id="1-4-ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º"><a href="#1-4-ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º" class="headerlink" title="1.4 ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º"></a>1.4 ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º</h3><p>ç›´æ¥çœ‹æºç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(String original)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.value = original.value;</span><br><span class="line">    <span class="keyword">this</span>.hash = original.hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æœ€ä¸ºç®€å•ï¼Œä½†è¦æ³¨æ„æ˜¯ä¸¤ä¸ªå­—ç¬¦ä¸²å¯¹è±¡<strong>å¼•ç”¨åŒä¸€ä¸ª char[] å¯¹è±¡</strong>ï¼Œä½†æ˜¯å¼•ç”¨å€¼ä¸ç›¸ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>&#125;);</span><br><span class="line">String s2 = <span class="keyword">new</span> String(s1);</span><br></pre></td></tr></table></figure>

<p>å†…å­˜ç»“æ„å¦‚ä¸‹</p>
<p><img src="st09.png" alt=""></p>
<h3 id="1-5-å­—é¢é‡åˆ›å»º"><a href="#1-5-å­—é¢é‡åˆ›å»º" class="headerlink" title="1.5 å­—é¢é‡åˆ›å»º"></a>1.5 å­—é¢é‡åˆ›å»º</h3><p>ä»¥ä¸Šå››ç§åˆ›å»ºæ–¹å¼ï¼Œå¤§å®¶ç”¨çš„å®é™…ä¸Šç›¸å¯¹å°‘ä¸€ç‚¹ï¼Œæœ€ç†Ÿæ‚‰çš„æ˜¯è¿™ç§å­—é¢é‡çš„æ–¹å¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String s = <span class="string">"abc"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>&quot;abc&quot;</code>  è¢«å«åšå­—ç¬¦ä¸²å­—é¢é‡</strong>ï¼ˆè‹±æ–‡ Literalï¼‰ï¼Œä½†æ°æ°æ˜¯è¿™ç§æ–¹å¼å…¶å®å¥¥å¦™æœ€å¤š<ul>
<li><strong>éå¯¹è±¡</strong></li>
<li><strong>æ‡’åŠ è½½</strong></li>
<li><strong>ä¸é‡å¤</strong></li>
</ul>
</li>
</ul>
<h4 id="1-5-1éå¯¹è±¡"><a href="#1-5-1éå¯¹è±¡" class="headerlink" title="1.5.1éå¯¹è±¡"></a>1.5.1éå¯¹è±¡</h4><p>ä¸¥æ ¼åœ°è¯´ï¼Œ<strong>å­—é¢é‡åœ¨ä»£ç è¿è¡Œåˆ°å®ƒæ‰€åœ¨è¯­å¥ä¹‹å‰ï¼Œå®ƒè¿˜ä¸æ˜¯å­—ç¬¦ä¸²å¯¹è±¡</strong></p>
<p>è¦ç†è§£ä»å­—é¢é‡å˜æˆå­—ç¬¦ä¸²å¯¹è±¡çš„è¿‡ç¨‹ï¼Œéœ€è¦ä»å­—èŠ‚ç çš„è§’åº¦æ¥åˆ†æ</p>
<p>åœ¨ä¸Šé¢çš„ java ä»£ç è¢«ç¼–è¯‘ä¸º class æ–‡ä»¶åï¼Œ<code>&quot;abc&quot;</code>  å­˜å‚¨äºã€ç±»æ–‡ä»¶å¸¸é‡æ± ã€‘ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Constant pool: &#x2F;&#x2F; å¸¸é‡æ± </span><br><span class="line">   #1 &#x3D; Methodref          #19.#41        &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; String             #42            &#x2F;&#x2F; abc</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>å½“ class å®Œæˆç±»åŠ è½½ä¹‹åï¼Œ<code>&quot;abc&quot;</code>  è¿™ä¸ªå­—é¢é‡è¢«å­˜å‚¨äºã€è¿è¡Œæ—¶å¸¸é‡æ± ã€‘ï¼ˆå½’å±äºæ–¹æ³•åŒºï¼‰ä¸­ï¼Œå…¶ä¸­ #1 #2 éƒ½ä¼šè¢«ç¿»è¯‘ä¸ºè¿è¡Œæ—¶çœŸæ­£çš„å†…å­˜åœ°å€</p>
<p>å†çœ‹ä¸€ä¸‹ class ä¸­ main æ–¹æ³•çš„å­—èŠ‚ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]); &#x2F;&#x2F; å­—èŠ‚ç æŒ‡ä»¤</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;1, locals&#x3D;2, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; String abc</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: return</span><br><span class="line">         ...</span><br></pre></td></tr></table></figure>

<p>å°†æ¥ main æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå°±ä¼šæ‰§è¡Œé‡Œé¢çš„å­—èŠ‚ç æŒ‡ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0: ldc           #2                  &#x2F;&#x2F; String abc</span><br><span class="line">2: astore_1</span><br><span class="line">3: return</span><br></pre></td></tr></table></figure>

<p><strong><code>ldc #2</code> å°±æ˜¯åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­æ‰¾åˆ° #2 çš„å†…å­˜åœ°å€ï¼Œæ‰¾åˆ° <code>&quot;abc&quot;</code>  è¿™ä¸ªå­—é¢é‡ï¼Œå†æ ¹æ®å®ƒåˆ›å»ºä¸€ä¸ª String å¯¹è±¡ã€‚</strong></p>
<p><img src="st11.png" alt=""></p>
<h4 id="1-5-2æ‡’åŠ è½½"><a href="#1-5-2æ‡’åŠ è½½" class="headerlink" title="1.5.2æ‡’åŠ è½½"></a>1.5.2æ‡’åŠ è½½</h4><ul>
<li><p><strong>å½“ç¬¬ä¸€æ¬¡ç”¨åˆ° <code>&quot;abc&quot;</code>  å­—é¢é‡æ—¶ï¼ˆå°±æ˜¯æ‰§è¡Œåˆ° <code>ldc #2</code> æ—¶ï¼‰ ï¼Œæ‰ä¼šåˆ›å»ºå¯¹åº”çš„å­—ç¬¦ä¸²å¯¹è±¡</strong></p>
</li>
<li><p>å¦‚ä½•éªŒè¯å‘¢ï¼Ÿ</p>
</li>
</ul>
<p>ä¾‹å¦‚æœ‰å¦‚ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.out.println();</span><br><span class="line">System.out.println(<span class="string">"1"</span>); <span class="comment">// æ–­ç‚¹1 2411</span></span><br><span class="line">System.out.println(<span class="string">"2"</span>); <span class="comment">// æ–­ç‚¹2 2412</span></span><br><span class="line">System.out.println(<span class="string">"3"</span>); <span class="comment">// æ–­ç‚¹3</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç»™æ¯è¡Œè¯­å¥åŠ ä¸Šæ–­ç‚¹ï¼Œç„¶åç”¨ idea çš„ debug ç•Œé¢ä¸­çš„ memory å·¥å…·æ¥æŸ¥çœ‹å­—ç¬¦ä¸²å¯¹è±¡çš„æ•°é‡</p>
<p>åˆšå¼€å§‹åœ¨æ–­ç‚¹1 å¤„ï¼Œå…¶å®ƒç±»ä¸­åˆ›å»ºçš„å­—ç¬¦ä¸²å¯¹è±¡æœ‰ 2411 ä¸ª</p>
<p><img src="st06.png" alt=""></p>
<p>æ‰§è¡Œåˆ°æ–­ç‚¹2 å¤„ï¼Œè¿™æ—¶æ–°åˆ›å»ºäº† <code>&quot;1&quot;</code> å¯¹åº”çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸ªæ•°ä¸º 2412</p>
<p><img src="st07.png" alt=""></p>
<p>æ‰§è¡Œåˆ°æ–­ç‚¹3 å¤„ï¼Œè¿™æ—¶æ–°åˆ›å»ºäº† <code>&quot;2&quot;</code> å¯¹åº”çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¸ªæ•°ä¸º 2413</p>
<p><img src="st08.png" alt=""></p>
<h4 id="1-5-3ä¸é‡å¤"><a href="#1-5-3ä¸é‡å¤" class="headerlink" title="1.5.3ä¸é‡å¤"></a>1.5.3ä¸é‡å¤</h4><p><strong>åŒä¸€ä¸ªç±»ä¸­çš„å€¼ç›¸åŒå­—é¢é‡ï¼Œå…¶å®åªæœ‰ä¸€ä»½</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestString1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s1 = <span class="string">"abc"</span>;</span><br><span class="line">        String s2 = <span class="string">"abc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¸¸é‡æ± ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 &#x3D; Methodref          #25.#48        &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; String             #49            &#x2F;&#x2F; abc</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„å­—èŠ‚ç ä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;1, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; String abc</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: ldc           #2                  &#x2F;&#x2F; String abc</span><br><span class="line">         5: astore_2</span><br><span class="line">         6: return</span><br><span class="line">         ...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ° <code>&quot;abc&quot;</code> è¿™ä¸ªå­—é¢é‡è™½ç„¶å‡ºç°äº† 2 æ¬¡ï¼Œä½†å®é™…ä¸Šéƒ½æ˜¯å¯¹åº”ç€å¸¸é‡æ± ä¸­ #2 è¿™ä¸ªåœ°å€</p>
<p>å¦‚æœæ˜¯ä¸åŒç±»ä¸­çš„ <code>&quot;abc&quot;</code> å‘¢ï¼Ÿã€ç±»æ–‡ä»¶å¸¸é‡æ± ã€‘åŒ…æ‹¬ã€è¿è¡Œæ—¶å¸¸é‡æ± ã€‘éƒ½æ˜¯ä»¥ç±»ä¸ºå•ä½çš„</p>
<p>ä¾‹å¦‚ï¼Œå¦ä¸€ä¸ªç±»ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestString2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s1 = <span class="string">"a"</span>;</span><br><span class="line">        String s2 = <span class="string">"abc"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„å¸¸é‡æ± </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 = Methodref          #5.#22         // java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">   #2 = String             #23            // a</span><br><span class="line">   #3 = String             #24            // abc</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨è¿™ä¸ªç±»ä¸­ï¼Œ<code>&quot;abc&quot;</code> å¯¹åº”çš„å¸¸é‡æ± çš„ç¼–å·æ˜¯ #3ï¼Œä¸ TestString1 ä¸­çš„å·²ç»ä¸åŒ</p>
<p>è¿™æ—¶å€™ã€å­—é¢é‡ã€‘æ˜¯ä¸¤ä»½ï¼Œè€Œã€å­—ç¬¦ä¸²å¯¹è±¡ã€‘ä¼šæœ‰å‡ ä¸ªå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬æ¥åšä¸ªå®éªŒï¼ŒæŠŠåˆšæ‰çš„ä»£ç åšä¸ªæ”¹å†™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestString1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String s1 = <span class="string">"abc"</span>; <span class="comment">// å­—ç¬¦ä¸²å¯¹è±¡ "abc"</span></span><br><span class="line">        String s2 = <span class="string">"abc"</span>; <span class="comment">// å­—ç¬¦ä¸²å¯¹è±¡ "abc"</span></span><br><span class="line">        TestString2.main(<span class="keyword">new</span> String[]&#123;s1, s2&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestString2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; <span class="comment">// args[0] "abc", args[1] "abc"</span></span><br><span class="line">        String s1 = <span class="string">"a"</span>;</span><br><span class="line">        String s2 = <span class="string">"abc"</span>;</span><br><span class="line">        System.out.println(args[<span class="number">0</span>] == s2);</span><br><span class="line">        System.out.println(args[<span class="number">1</span>] == s2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">true</span><br></pre></td></tr></table></figure>

<p>å…·ä½“åŸç†æˆ‘ä»¬ä¸‹ä¸€ä¸ªç« èŠ‚å†è®²</p>
<h3 id="1-5-æ‹¼æ¥åˆ›å»º"><a href="#1-5-æ‹¼æ¥åˆ›å»º" class="headerlink" title="1.5 æ‹¼æ¥åˆ›å»º"></a>1.5 æ‹¼æ¥åˆ›å»º</h3><p>æœ€åè¿˜å¯ä»¥é€šè¿‡ <code>+</code> è¿ç®—ç¬¦å°†ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼ˆå…¶ä¸­ä¸€ä¸ªä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒç±»å‹ï¼‰æ‹¼æ¥ä¸ºä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚</p>
<p>ä¾‹1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"a"</span> + <span class="string">"b"</span>;</span><br></pre></td></tr></table></figure>

<p>ä¾‹2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="string">"a"</span> + x;</span><br></pre></td></tr></table></figure>

<p>ä¾‹3</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="string">"a"</span> + x;</span><br></pre></td></tr></table></figure>

<p>ä¾‹4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"a"</span> + <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>æœ‰åŒå­¦ä¼šé—®ï¼Œä¾‹1ä¸ä¾‹2ä¸ä¾‹3 ä¸åŒå—ï¼Ÿè¿˜åˆ«è¯´ï¼ŒçœŸå°±ä¸åŒï¼Œå…¶ä¸­ä¾‹1 ä¸ä¾‹2 åŸç†æ˜¯ä¸€æ ·çš„ï¼Œä¾‹3 ä¸ä¾‹4 åŸç†æ˜¯ä¸€æ ·çš„ï¼Œåç¼–è¯‘ä¸€ä¸‹</p>
<p>ä¾‹1 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">"a"</span> + <span class="string">"b"</span>;</span><br></pre></td></tr></table></figure>

<p>å¸¸é‡æ± </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 &#x3D; Methodref          #4.#20         &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; String             #21            &#x2F;&#x2F; ab</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>ä¸»æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;1, locals&#x3D;2, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; String ab</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: return</span><br><span class="line">         ...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å¹¶æ²¡æœ‰çœŸæ­£çš„ã€æ‹¼æ¥ã€‘æ“ä½œå‘ç”Ÿï¼Œä»æºç ç¼–è¯‘ä¸ºå­—èŠ‚ç æ—¶ï¼Œjavac å°±å·²ç»æŠŠ â€œaâ€ å’Œ â€œbâ€ ä¸²åœ¨ä¸€èµ·äº†ï¼Œè¿™æ˜¯ä¸€ç§ç¼–è¯‘æœŸçš„ä¼˜åŒ–å¤„ç†</p>
<p>ä¾‹2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="string">"a"</span> + x;</span><br></pre></td></tr></table></figure>

<p>å¸¸é‡æ± </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 &#x3D; Methodref          #5.#22         &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; String             #23            &#x2F;&#x2F; b</span><br><span class="line">   #3 &#x3D; String             #24            &#x2F;&#x2F; ab</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>ä¸»æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;1, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; String b   final b</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: ldc           #3                  &#x2F;&#x2F; String ab</span><br><span class="line">         5: astore_2</span><br><span class="line">         6: return</span><br><span class="line">         ...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿˜æ˜¯æ²¡æœ‰çœŸæ­£çš„ã€æ‹¼æ¥ã€‘æ“ä½œå‘ç”Ÿï¼Œfinal æ„å‘³ç€ x çš„å€¼ä¸å¯æ”¹å˜ï¼Œå› æ­¤å…¶å®ƒå¼•ç”¨ x çš„åœ°æ–¹éƒ½å¯ä»¥å®‰å…¨åœ°è¢«æ›¿æ¢ä¸º â€œbâ€ï¼Œè€Œä¸ç”¨æ‹…å¿ƒ x è¢«æ”¹å˜ï¼Œä»æºç ç¼–è¯‘ä¸ºå­—èŠ‚ç æ—¶ï¼Œjavac å°±ä¹Ÿè¿›è¡Œäº†ä¼˜åŒ–ï¼ŒæŠŠæ‰€æœ‰å‡ºç° x çš„åœ°æ–¹éƒ½æ›¿æ¢æˆä¸ºäº† â€œbâ€</p>
<p>é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯çœŸæ­£çš„ã€æ‹¼æ¥ã€‘æ“ä½œå‘¢ï¼Ÿçœ‹ä¸€ä¸‹ä¾‹3 åç¼–è¯‘åçš„ç»“æœ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="string">"a"</span> + x;</span><br></pre></td></tr></table></figure>

<p>å¸¸é‡æ± </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 &#x3D; Methodref          #9.#26         &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; String             #27            &#x2F;&#x2F; b</span><br><span class="line">   #3 &#x3D; Class              #28            &#x2F;&#x2F; java&#x2F;lang&#x2F;StringBuilder</span><br><span class="line">   #4 &#x3D; Methodref          #3.#26         &#x2F;&#x2F; java&#x2F;lang&#x2F;StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #5 &#x3D; String             #29            &#x2F;&#x2F; a</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å¸¸é‡æ± ä¸­å¹¶æ²¡æœ‰ ab å­—é¢é‡</p>
<p>ä¸»æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;2, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; String b</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: new           #3                  &#x2F;&#x2F; class java&#x2F;lang&#x2F;StringBuilder</span><br><span class="line">         6: dup</span><br><span class="line">         7: invokespecial #4                  &#x2F;&#x2F; Method java&#x2F;lang&#x2F;StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">        10: ldc           #5                  &#x2F;&#x2F; String a</span><br><span class="line">        12: invokevirtual #6                  &#x2F;&#x2F; Method java&#x2F;lang&#x2F;StringBuilder.append:(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;StringBuilder;</span><br><span class="line">        15: aload_1</span><br><span class="line">        16: invokevirtual #6                  &#x2F;&#x2F; Method java&#x2F;lang&#x2F;StringBuilder.append:(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;StringBuilder;</span><br><span class="line">        19: invokevirtual #7                  &#x2F;&#x2F; Method java&#x2F;lang&#x2F;StringBuilder.toString:()Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">        22: astore_2</span><br><span class="line">        23: return</span><br></pre></td></tr></table></figure>

<p>ç¿»è¯‘æˆäººèƒ½è¯»æ‡‚çš„å°±æ˜¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="string">"a"</span> + x;</span><br><span class="line"></span><br><span class="line">String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="keyword">new</span> StringBuilder().append(<span class="string">"a"</span>).append(x).toString();</span><br></pre></td></tr></table></figure>

<p>StringBuilder çš„ toString() æ–¹æ³•åˆæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StringBuilder</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractStringBuilder</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>, <span class="title">CharSequence</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä» AbstractStringBuilder ç»§æ‰¿çš„å±æ€§ï¼Œæ–¹ä¾¿é˜…è¯»åŠ åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">char</span>[] value;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Create a copy, don't share the array</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(value, <span class="number">0</span>, count);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯æ ¹æ® StringBuilder ç»´æŠ¤çš„ char[] åˆ›å»ºäº†æ–°çš„ String å¯¹è±¡</p>
<h3 id="1-6-JDK-9-ä¹‹åçš„æ”¹å˜"><a href="#1-6-JDK-9-ä¹‹åçš„æ”¹å˜" class="headerlink" title="1.6 JDK 9 ä¹‹åçš„æ”¹å˜"></a>1.6 JDK 9 ä¹‹åçš„æ”¹å˜</h3><p>å‰é¢æˆ‘ä»¬è®²çš„æ˜¯ JDK 8 ä¸­çš„å­—ç¬¦ä¸²ï¼Œä½†ä» JDK 9 å¼€å§‹ï¼ŒString çš„å†…éƒ¨å­˜å‚¨æ–¹å¼ã€ä»¥åŠæ‹¼æ¥æ–¹å¼åˆå‘ç”Ÿäº†è¾ƒå¤§çš„æ”¹å˜</p>
<ul>
<li>ä¸å†ç”¨ char[] å­˜å‚¨å­—ç¬¦ï¼Œæ”¹ä¸ºäº† byte[]ï¼Œç›®çš„æ˜¯æ›´èŠ‚çº¦å†…å­˜</li>
<li>ä½¿ç”¨ invokedynamic æŒ‡ä»¤æ‰©å±•äº†å­—ç¬¦ä¸²çš„æ‹¼æ¥çš„å®ç°æ–¹å¼</li>
</ul>
<h4 id="1-6-1å†…å­˜ç»“æ„æ”¹å˜"><a href="#1-6-1å†…å­˜ç»“æ„æ”¹å˜" class="headerlink" title="1.6.1å†…å­˜ç»“æ„æ”¹å˜"></a>1.6.1å†…å­˜ç»“æ„æ”¹å˜</h4><p>ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²ä¸­ä»…æœ‰æ‹‰ä¸å­—ç¬¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;<span class="number">97</span>, <span class="number">98</span>, <span class="number">99</span>&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="st12.png" alt=""></p>
<p>ä¾‹å¦‚ï¼Œå­—ç¬¦ä¸²ä¸­æœ‰ä¸­æ–‡å­—ç¬¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(</span><br><span class="line">    <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>) <span class="number">0xd5</span>, (<span class="keyword">byte</span>) <span class="number">0xc5</span>&#125;, </span><br><span class="line">    Charset.forName(<span class="string">"gbk"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="st13.png" alt=""></p>
<p>ä¾‹å¦‚ï¼Œæ—¢æœ‰ä¸­æ–‡å­—ç¬¦ä¹Ÿæœ‰æ‹‰ä¸å­—ç¬¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(</span><br><span class="line">    <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>) <span class="number">0xd5</span>, (<span class="keyword">byte</span>) <span class="number">0xc5</span>, <span class="number">97</span>&#125;, </span><br><span class="line">    Charset.forName(<span class="string">"gbk"</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p><img src="st14.png" alt=""></p>
<h4 id="1-6-2æ‹¼æ¥æ–¹å¼æ”¹å˜"><a href="#1-6-2æ‹¼æ¥æ–¹å¼æ”¹å˜" class="headerlink" title="1.6.2æ‹¼æ¥æ–¹å¼æ”¹å˜"></a>1.6.2æ‹¼æ¥æ–¹å¼æ”¹å˜</h4><p>ä¾‹å¦‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String x = <span class="string">"b"</span>;</span><br><span class="line">    String s = <span class="string">"a"</span> + x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¸¸é‡æ± </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Constant pool:</span><br><span class="line">   #1 &#x3D; Methodref          #5.#22         &#x2F;&#x2F; java&#x2F;lang&#x2F;Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   #2 &#x3D; String             #23            &#x2F;&#x2F; b</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>ä¸»æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava&#x2F;lang&#x2F;String;)V</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack&#x3D;1, locals&#x3D;3, args_size&#x3D;1</span><br><span class="line">         0: ldc           #2                  &#x2F;&#x2F; String b</span><br><span class="line">         2: astore_1</span><br><span class="line">         3: aload_1</span><br><span class="line">         4: invokedynamic #3,  0              &#x2F;&#x2F; InvokeDynamic #0:makeConcatWithConstants:(Ljava&#x2F;lang&#x2F;String;)Ljava&#x2F;lang&#x2F;String;</span><br><span class="line">         9: astore_2</span><br><span class="line">        10: return</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥è·Ÿ <code>invokedynamic</code> å¯¹åº”çš„å­—èŠ‚ç æ¯”è¾ƒéš¾ï¼Œæˆ‘ç›´æ¥ç¿»è¯‘æˆäººèƒ½çœ‹æ‡‚çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    String x = <span class="string">"b"</span>;</span><br><span class="line">    <span class="comment">// String s = "a" + x; </span></span><br><span class="line">    <span class="comment">// ä¼šç”Ÿæˆå¦‚ä¸‹ç­‰ä»·çš„å­—èŠ‚ç </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼–è¯‘å™¨ä¼šæä¾› lookupï¼Œç”¨æ¥æŸ¥æ‰¾ MethodHandle</span></span><br><span class="line">    MethodHandles.Lookup lookup = MethodHandles.lookup();</span><br><span class="line">    CallSite callSite = StringConcatFactory.makeConcatWithConstants(</span><br><span class="line">        lookup,</span><br><span class="line">        <span class="comment">// æ–¹æ³•åï¼Œä¸é‡è¦ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆ</span></span><br><span class="line">        <span class="string">"arbitrary"</span>,</span><br><span class="line">        <span class="comment">// æ–¹æ³•çš„ç­¾åï¼Œç¬¬ä¸€ä¸ª String ä¸ºè¿”å›å€¼ç±»å‹ï¼Œä¹‹åæ˜¯å…¥å‚ç±»å‹</span></span><br><span class="line">        MethodType.methodType(String<span class="class">.<span class="keyword">class</span>, <span class="title">String</span>.<span class="title">class</span>),</span></span><br><span class="line"><span class="class">        // å…·ä½“å¤„æ–¹æ ¼å¼ï¼Œå…¶ä¸­ \1 æ„æ€æ˜¯å˜é‡çš„å ä½ç¬¦ï¼Œå°†æ¥è¢« <span class="title">x</span> ä»£æ›¿</span></span><br><span class="line">        "a\1"</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// callSite.getTarget() è¿”å›çš„æ˜¯ MethodHandle å¯¹è±¡ï¼Œç”¨æ¥åå°„æ‰§è¡Œæ‹¼æ¥æ–¹æ³•</span></span><br><span class="line">    String s = (String) callSite.getTarget().invoke(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ä¸ºä»€ä¹ˆæè¿™ä¹ˆéº»çƒ¦ï¼ï¼ï¼</strong>ä¸»è¦æ˜¯ä¸ºäº†å¯¹å­—ç¬¦ä¸²çš„æ‹¼æ¥åšå„ç§æ‰©å±•ä¼˜åŒ–ï¼Œå¤šäº†æ‰©å±•é€”å¾„ã€‚å…¶ä¸­æœ€ä¸ºé‡è¦çš„æ˜¯ <code>MethodHandle</code> ï¼Œå®ƒä½¿ç”¨äº†<strong>ç­–ç•¥æ¨¡å¼</strong>ç”Ÿæˆï¼ŒJDK æä¾›çš„æ‰€æœ‰çš„ç­–ç•¥å¯ä»¥åœ¨ <code>StringConcatFactory.Strategy</code> ä¸­æ‰¾åˆ°ï¼š</p>
<table>
<thead>
<tr>
<th>ç­–ç•¥å</th>
<th>å†…éƒ¨è°ƒç”¨</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody><tr>
<td>BC_SB</td>
<td>å­—èŠ‚ç æ‹¼æ¥ç”Ÿæˆ StringBuilder ä»£ç </td>
<td>ç­‰ä»·äº new StringBuilder()</td>
</tr>
<tr>
<td>BC_SB_SIZED</td>
<td>å­—èŠ‚ç æ‹¼æ¥ç”Ÿæˆ StringBuilder ä»£ç </td>
<td>ç­‰ä»·äº new StringBuilder(n) nä¸ºé¢„ä¼°å¤§å°</td>
</tr>
<tr>
<td>BC_SB_SIZED_EXACT</td>
<td>å­—èŠ‚ç æ‹¼æ¥ç”Ÿæˆ StringBuilder ä»£ç </td>
<td>ç­‰ä»·äº new StringBuilder(n) nä¸ºå‡†ç¡®å¤§å°</td>
</tr>
<tr>
<td>MH_SB_SIZED</td>
<td>MethodHandle ç”Ÿæˆ StringBuilder ä»£ç </td>
<td>ç­‰ä»·äº new StringBuilder(n) nä¸ºé¢„ä¼°å¤§å°</td>
</tr>
<tr>
<td>MH_SB_SIZED_EXACT</td>
<td>MethodHandle ç”Ÿæˆ StringBuilder ä»£ç </td>
<td>ç­‰ä»·äº new StringBuilder(n) nä¸ºå‡†ç¡®å¤§å°</td>
</tr>
<tr>
<td>MH_INLINE_SIZED_EXACT</td>
<td>MethodHandle å†…éƒ¨ä½¿ç”¨å­—èŠ‚æ•°ç»„ç›´æ¥æ„é€ å‡º String</td>
<td>é»˜è®¤ç­–ç•¥</td>
</tr>
</tbody></table>
<p>å¦‚æœæƒ³æ”¹å˜ç­–ç•¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ  JVM å‚æ•°ï¼Œä¾‹å¦‚å°†ç­–ç•¥æ”¹ä¸º BC_SB</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Djava.lang.invoke.stringConcat&#x3D;BC_SB</span><br><span class="line">-Djava.lang.invoke.stringConcat.debug&#x3D;true</span><br><span class="line">-Djava.lang.invoke.stringConcat.dumpClasses&#x3D;åŒ¿åç±»å¯¼å‡ºè·¯å¾„</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ç§é€‰æ‹©ï¼Œæ˜¯åœ¨ <code>javac</code> ç¼–è¯‘æ—¶ä»ä½¿ç”¨JDK1.5<code>StringBuilder</code>çš„åŠæ³•æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯é‡‡ç”¨ <code>invokedynamic</code>ï¼Œå°±æ˜¯åœ¨ <code>javac</code> æ—¶åŠ ä¸Šå‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XDstringConcat&#x3D;inline</span><br></pre></td></tr></table></figure>





<h4 id="1-6-3é»˜è®¤æ‹¼æ¥ç­–ç•¥"><a href="#1-6-3é»˜è®¤æ‹¼æ¥ç­–ç•¥" class="headerlink" title="1.6.3é»˜è®¤æ‹¼æ¥ç­–ç•¥"></a>1.6.3é»˜è®¤æ‹¼æ¥ç­–ç•¥</h4><p>é»˜è®¤ç­–ç•¥ä¸º MH_INLINE_SIZED_EXACTï¼Œä½¿ç”¨å­—èŠ‚æ•°ç»„ç›´æ¥æ„é€ å‡º String</p>
<p>ä¾‹å¦‚æœ‰ä¸‹é¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"b"</span>;</span><br><span class="line">String s = <span class="string">"a"</span> + x + <span class="string">"c"</span> + <span class="string">"d"</span>;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨äº† MH_INLINE_SIZED_EXACT ç­–ç•¥åï¼Œå†…éƒ¨ä¼šæ‰§è¡Œå¦‚ä¸‹ç­‰ä»·è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"b"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é¢„å…ˆåˆ†é…å­—ç¬¦ä¸²éœ€è¦çš„å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºæ–°å­—ç¬¦ä¸²ï¼Œè¿™æ—¶å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼ä¸º [0,0,0,0]</span></span><br><span class="line">String s = StringConcatHelper.newString(buf, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œã€æ‹¼æ¥ã€‘ï¼Œå­—ç¬¦ä¸²å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼ä¸º [97,0,0,0]</span></span><br><span class="line">StringConcatHelper.prepend(<span class="number">1</span>, buf, <span class="string">"a"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œã€æ‹¼æ¥ã€‘ï¼Œå­—ç¬¦ä¸²å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼ä¸º [97,98,0,0]</span></span><br><span class="line">StringConcatHelper.prepend(<span class="number">2</span>, buf, x);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œã€æ‹¼æ¥ã€‘ï¼Œå­—ç¬¦ä¸²å†…éƒ¨å­—èŠ‚æ•°ç»„å€¼ä¸º [97,98,99,100]</span></span><br><span class="line">StringConcatHelper.prepend(<span class="number">4</span>, buf, <span class="string">"cd"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ°æ­¤ã€æ‹¼æ¥å®Œæ¯•ã€‘</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ³¨æ„</strong> </p>
<ul>
<li>StringConcatHelper å¯¹å¤–æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤æ— æ³•ç›´æ¥æµ‹è¯•ï¼Œåªèƒ½åå°„æµ‹è¯•</li>
<li>prepend å¯ä»¥ç›´æ¥ä¿®æ”¹å­—ç¬¦ä¸²ä¸­çš„ bytes å±æ€§å€¼ï¼Œä»–ä»¬éƒ½æ˜¯ java.lang åŒ…ä¸‹çš„</li>
</ul>
</blockquote>
<h4 id="1-6-4æ¨¡ä»¿-BC-SB-ç­–ç•¥"><a href="#1-6-4æ¨¡ä»¿-BC-SB-ç­–ç•¥" class="headerlink" title="1.6.4æ¨¡ä»¿ BC_SB ç­–ç•¥"></a>1.6.4æ¨¡ä»¿ BC_SB ç­–ç•¥</h4><p>æ¥ä¸‹æ¥æˆ‘æ¨¡æ‹Ÿå…¶ä¸­ä¸€ç§ç­–ç•¥çš„å®ç°è¿‡ç¨‹ï¼šä»¥å­—èŠ‚ç æŒ‡ä»¤ç”Ÿæˆæ‹¼æ¥æ–¹æ³•ä¸ºä¾‹</p>
<p>å…ˆè¯´æ˜ä¸€ä¸‹æˆ‘çš„ç›®çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"hello,"</span>;</span><br><span class="line">String y = <span class="string">"world"</span>;</span><br><span class="line">String s = x + y;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ + å¯ä»¥è¢« invokedynamic ä¼˜åŒ–ä¸ºå¤šç§å®ç°ç­–ç•¥ï¼Œå¦‚æœè®©æˆ‘è‡ªå·±æ¥å®ç°ï¼Œæˆ‘ä»…ä¼šç”¨ StringBuilder æ¥æ‹¼æ¥ï¼Œå› æ­¤æˆ‘å¸Œæœ› x+y èƒ½å¤Ÿè¢«ç¿»è¯‘ä¸ºå¯¹ä¸‹é¢æ–¹æ³•çš„è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">concat</span><span class="params">(String x, String y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder().append(x).append(y).toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="1-æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ"><a href="#1-æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ" class="headerlink" title="1. æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ"></a>1. æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ</h5><p>æä¾›ä¸€ä¸ªæ‹¼æ¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">concat</span><span class="params">(String x, String y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder().append(x).append(y).toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”¨ MethodHandle åå°„è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"hello,"</span>;</span><br><span class="line">String y = <span class="string">"world"</span>;</span><br><span class="line">MethodHandle mh = MethodHandles.lookup().findStatic(</span><br><span class="line">    TestString4<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line">    "concat", </span><br><span class="line">    MethodType.methodType(String<span class="class">.<span class="keyword">class</span>, <span class="title">String</span>.<span class="title">class</span>, <span class="title">String</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">)</span>;</span><br><span class="line">String s = (String) mh.invoke(x,y);</span><br><span class="line">System.out.println(s);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello,world</span><br></pre></td></tr></table></figure>

<p>ä½†è¿™æ ·éœ€è¦è‡ªå·±æä¾› concat æ–¹æ³•ï¼Œè€Œä¸”å…¶å‚æ•°ä¸ªæ•°éƒ½å›ºå®šæ­»äº†ï¼Œèƒ½å¦åŠ¨æ€ç”Ÿæˆè¿™ä¹ˆä¸€ä¸ªæ–¹æ³•å‘¢ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œä¸ºäº†ç®€åŒ–ç”Ÿæˆé€»è¾‘ï¼Œè¿™é‡Œæˆ‘ä»ç„¶ä»¥å›ºå®šå‚æ•°ä¸ºä¾‹</p>
<h5 id="2-å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•"><a href="#2-å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•" class="headerlink" title="2. å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•"></a>2. å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•</h5><p>Unsafe å¯¹è±¡è®¿é—®ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeAccessor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");</span><br><span class="line">            theUnsafe.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            UNSAFE = (Unsafe) theUnsafe.get(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ asm ç”ŸæˆåŒ¿åç±»å­—èŠ‚ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] dump() &#123;</span><br><span class="line"></span><br><span class="line">    ClassWriter cw = <span class="keyword">new</span> ClassWriter(<span class="number">0</span>);</span><br><span class="line">    FieldVisitor fv;</span><br><span class="line">    MethodVisitor mv;</span><br><span class="line">    AnnotationVisitor av0;</span><br><span class="line"></span><br><span class="line">    cw.visit(<span class="number">52</span>, ACC_PUBLIC + ACC_SUPER, <span class="string">"cn/itcast/string/TestString4"</span>, <span class="keyword">null</span>, <span class="string">"java/lang/Object"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    cw.visitSource(<span class="string">"TestString4.java"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        mv = cw.visitMethod(ACC_PUBLIC, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        mv.visitCode();</span><br><span class="line">        Label l0 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l0);</span><br><span class="line">        mv.visitLineNumber(<span class="number">3</span>, l0);</span><br><span class="line">        mv.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">        mv.visitMethodInsn(INVOKESPECIAL, <span class="string">"java/lang/Object"</span>, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mv.visitInsn(RETURN);</span><br><span class="line">        Label l1 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l1);</span><br><span class="line">        mv.visitLocalVariable(<span class="string">"this"</span>, <span class="string">"Lcn/itcast/string/TestString4;"</span>, <span class="keyword">null</span>, l0, l1, <span class="number">0</span>);</span><br><span class="line">        mv.visitMaxs(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        mv.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        mv = cw.visitMethod(ACC_PUBLIC + ACC_STATIC, <span class="string">"concat"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        mv.visitCode();</span><br><span class="line">        Label l0 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l0);</span><br><span class="line">        mv.visitLineNumber(<span class="number">9</span>, l0);</span><br><span class="line">        mv.visitTypeInsn(NEW, <span class="string">"java/lang/StringBuilder"</span>);</span><br><span class="line">        mv.visitInsn(DUP);</span><br><span class="line">        mv.visitMethodInsn(INVOKESPECIAL, <span class="string">"java/lang/StringBuilder"</span>, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mv.visitVarInsn(ALOAD, <span class="number">0</span>);</span><br><span class="line">        mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">"java/lang/StringBuilder"</span>, <span class="string">"append"</span>, <span class="string">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mv.visitVarInsn(ALOAD, <span class="number">1</span>);</span><br><span class="line">        mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">"java/lang/StringBuilder"</span>, <span class="string">"append"</span>, <span class="string">"(Ljava/lang/String;)Ljava/lang/StringBuilder;"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mv.visitMethodInsn(INVOKEVIRTUAL, <span class="string">"java/lang/StringBuilder"</span>, <span class="string">"toString"</span>, <span class="string">"()Ljava/lang/String;"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mv.visitInsn(ARETURN);</span><br><span class="line">        Label l1 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l1);</span><br><span class="line">        mv.visitLocalVariable(<span class="string">"x"</span>, <span class="string">"Ljava/lang/String;"</span>, <span class="keyword">null</span>, l0, l1, <span class="number">0</span>);</span><br><span class="line">        mv.visitLocalVariable(<span class="string">"y"</span>, <span class="string">"Ljava/lang/String;"</span>, <span class="keyword">null</span>, l0, l1, <span class="number">1</span>);</span><br><span class="line">        mv.visitMaxs(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">        mv.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">    cw.visitEnd();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cw.toByteArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¹ˆå¤šå­—èŠ‚ç ä¸»è¦ç›®çš„ä»…ä»…æ˜¯ç”Ÿæˆä¸€ä¸ªåŒ¿åç±»çš„å­—èŠ‚ç ï¼Œå…¶ä¸­åŒ…æ‹¬äº†æ‹¼æ¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">concat</span><span class="params">(String x, String y)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder().append(x).append(y).toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±å¯ä»¥ç”ŸæˆåŒ¿åç±»ï¼Œä¾› MethodHandler åå°„è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”ŸæˆåŒ¿åç±»æ‰€éœ€å­—èŠ‚ç </span></span><br><span class="line"><span class="keyword">byte</span>[] bytes = dump();</span><br><span class="line"><span class="comment">// æ ¹æ®å­—èŠ‚ç ç”ŸæˆåŒ¿åç±».class</span></span><br><span class="line">Class&lt;?&gt; innerClass = UnsafeAccessor.UNSAFE</span><br><span class="line">    .defineAnonymousClass(TestString4<span class="class">.<span class="keyword">class</span>, <span class="title">bytes</span>, <span class="title">null</span>)</span>;</span><br><span class="line"><span class="comment">// ç¡®ä¿åŒ¿åç±»åˆå§‹åŒ–</span></span><br><span class="line">UnsafeAccessor.UNSAFE.ensureClassInitialized(innerClass);</span><br><span class="line"><span class="comment">// æ‰¾åˆ°åŒ¿åç±»ä¸­ String concat(String x, String y)</span></span><br><span class="line">MethodHandle mh = MethodHandles.lookup().findStatic(</span><br><span class="line">    innerClass,</span><br><span class="line">    <span class="string">"concat"</span>, </span><br><span class="line">    MethodType.methodType(String<span class="class">.<span class="keyword">class</span>, <span class="title">String</span>.<span class="title">class</span>, <span class="title">String</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">)</span>;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆå°±å¯ä»¥ä½¿ç”¨è¯¥ MethodHandle åå°„å®Œæˆå­—ç¬¦ä¸²æ‹¼æ¥äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">"hello,"</span>;</span><br><span class="line">String y = <span class="string">"world"</span>;</span><br><span class="line">String s = (String) mh.invoke(x, y);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello,world</span><br></pre></td></tr></table></figure>

<p>JDK 9 å½“ç„¶åšçš„æ›´ä¸ºä¸“ä¸šï¼Œå¯ä»¥é€‚é…ç”Ÿæˆä¸åŒçš„å‚æ•°ä¸ªæ•°ã€ç±»å‹çš„ MethodHandleï¼Œä½†åŸç†å°±æ˜¯è¿™æ ·ã€‚</p>
<h2 id="2-å­—ç¬¦ä¸²ä¹‹å®¶-StringTable"><a href="#2-å­—ç¬¦ä¸²ä¹‹å®¶-StringTable" class="headerlink" title="2.å­—ç¬¦ä¸²ä¹‹å®¶ - StringTable"></a>2.å­—ç¬¦ä¸²ä¹‹å®¶ - StringTable</h2><h3 id="2-1-å®¶å…»ä¸é‡ç”Ÿ"><a href="#2-1-å®¶å…»ä¸é‡ç”Ÿ" class="headerlink" title="2.1 å®¶å…»ä¸é‡ç”Ÿ"></a>2.1 å®¶å…»ä¸é‡ç”Ÿ</h3><p>å…¶å®å­—ç¬¦ä¸²åˆ†ä¸ºå®¶å…»çš„å’Œé‡ç”Ÿçš„ã€‚</p>
<p>å‰é¢æˆ‘ä»¬è®²è§£äº† String çš„å…­ç§åˆ›å»ºæ–¹å¼ï¼Œ<strong>é™¤äº†å­—é¢é‡æ–¹å¼åˆ›å»ºçš„å­—ç¬¦ä¸²æ˜¯å®¶å…»çš„ä»¥å¤–ï¼Œå…¶å®ƒæ–¹æ³•åˆ›å»ºçš„å­—ç¬¦ä¸²éƒ½æ˜¯é‡ç”Ÿçš„ã€‚</strong>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ</p>
<ul>
<li><p>å­—é¢é‡æ–¹å¼åˆ›å»ºçš„å­—ç¬¦ä¸²ï¼Œä¼šæ”¾å…¥ StringTable ä¸­ï¼ŒStringTable ç®¡ç†çš„å­—ç¬¦ä¸²ï¼Œæ‰å…·æœ‰ä¸é‡å¤çš„ç‰¹æ€§ï¼Œè¿™ç§å°±åƒæ˜¯å®¶å…»çš„</p>
</li>
<li><p>è€Œ char[]ï¼Œbyte[]ï¼Œint[]ï¼ŒStringï¼Œä»¥åŠ + æ–¹å¼æœ¬è´¨ä¸Šéƒ½æ˜¯ä½¿ç”¨ new æ¥åˆ›å»ºï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨å †ä¸­åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ<strong>ä¸ä¼šè€ƒè™‘å­—ç¬¦ä¸²é‡ä¸é‡å¤</strong>ï¼Œè¿™ç§å°±åƒæ˜¯é‡ç”Ÿçš„ï¼Œé‡ç”Ÿå­—ç¬¦ä¸²çš„ç¼ºç‚¹å°±æ˜¯å¦‚æœå­˜åœ¨å¤§é‡å€¼ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå¯¹å†…å­˜å ç”¨éå¸¸ä¸¥é‡</p>
</li>
</ul>
<p>å¦‚ä½•ä¿è¯å®¶å…»çš„å­—ç¬¦ä¸²å¯¹è±¡ä¸é‡å¤å‘¢ï¼ŸJDK ä½¿ç”¨äº† <strong>StringTable æ¥è§£å†³ï¼ŒStringTable æ˜¯é‡‡ç”¨ c++ ä»£ç ç¼–å†™çš„ï¼Œæ•°æ®ç»“æ„ä¸Šå°±æ˜¯ä¸€ä¸ª hash è¡¨</strong>ï¼Œå­—ç¬¦ä¸²å¯¹è±¡å°±å……å½“ hash è¡¨ä¸­çš„ keyï¼Œkey çš„ä¸é‡å¤æ€§ï¼Œæ˜¯ hash è¡¨çš„åŸºæœ¬ç‰¹æ€§</p>
<p><img src="st10.png" alt=""></p>
<p>å½“ä»£ç è¿è¡Œåˆ°ä¸€ä¸ªå­—é¢é‡ â€œabcâ€ æ—¶ï¼Œä¼šé¦–å…ˆæ£€æŸ¥ StringTable ä¸­æœ‰æ²¡æœ‰ç›¸åŒçš„ keyï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºæ–°å­—ç¬¦ä¸²å¯¹è±¡åŠ å…¥ï¼›å¦åˆ™ç›´æ¥è¿”å›å·²æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡</p>
<h3 id="2-2-æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²"><a href="#2-2-æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²" class="headerlink" title="2.2 æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²"></a>2.2 æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²</h3><p>é‡ç”Ÿçš„å­—ç¬¦ä¸²ä¹Ÿæœ‰æœºä¼šå¾—åˆ°æ•™è‚²</p>
<p>å­—ç¬¦ä¸²æä¾›äº† intern æ–¹æ³•æ¥å®ç°å»é‡ï¼Œè®©å­—ç¬¦ä¸²å¯¹è±¡æœ‰æœºä¼šå—åˆ° StringTable çš„ç®¡ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">intern</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>å®ƒä¼šå°è¯•å°†è°ƒç”¨è€…æ”¾å…¥ StringTable</p>
<h4 id="2-2-1å¦‚æœ-StringTable-ä¸­å·²æœ‰"><a href="#2-2-1å¦‚æœ-StringTable-ä¸­å·²æœ‰" class="headerlink" title="2.2.1å¦‚æœ StringTable ä¸­å·²æœ‰"></a>2.2.1å¦‚æœ StringTable ä¸­å·²æœ‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = ...;</span><br><span class="line">String s = x.intern();</span><br></pre></td></tr></table></figure>

<p>æ€»ä¼šè¿”å›å®¶å…»çš„ String å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram </span><br><span class="line">participant x as x</span><br><span class="line">participant s as s</span><br><span class="line">participant st as StringTable</span><br><span class="line"></span><br><span class="line">x -&gt;&gt; st : intern()</span><br><span class="line">st -&gt;&gt; st : å¦‚æœå·²æœ‰</span><br><span class="line">st --&gt;&gt; s : è¿”å› StringTable å¯¹è±¡</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>&#125;); <span class="comment">// é‡ç”Ÿçš„</span></span><br><span class="line">String y = <span class="string">"abc"</span>; <span class="comment">// å°† "abc"å­—ç¬¦ä¸²å¯¹è±¡ åŠ å…¥ StringTable</span></span><br><span class="line">String z = x.intern(); <span class="comment">// å·²æœ‰ï¼Œè¿”å› StringTable ä¸­ "abc"ï¼Œå³ y</span></span><br><span class="line">System.out.println(z == y);</span><br><span class="line">System.out.println(z == x);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">false</span><br></pre></td></tr></table></figure>



<h4 id="2-2-2å¦‚æœ-StringTable-ä¸­æ²¡æœ‰ï¼ˆ1-7-ä»¥ä¸Š-JDK-çš„åšæ³•ï¼‰"><a href="#2-2-2å¦‚æœ-StringTable-ä¸­æ²¡æœ‰ï¼ˆ1-7-ä»¥ä¸Š-JDK-çš„åšæ³•ï¼‰" class="headerlink" title="2.2.2å¦‚æœ StringTable ä¸­æ²¡æœ‰ï¼ˆ1.7 ä»¥ä¸Š JDK çš„åšæ³•ï¼‰"></a>2.2.2å¦‚æœ StringTable ä¸­æ²¡æœ‰ï¼ˆ1.7 ä»¥ä¸Š JDK çš„åšæ³•ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = ...;</span><br><span class="line">String s = x.intern();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram </span><br><span class="line">participant x as x</span><br><span class="line">participant s as s</span><br><span class="line">participant st as StringTable</span><br><span class="line"></span><br><span class="line">x -&gt;&gt; st : intern()</span><br><span class="line">st -&gt;&gt; st : å¦‚æœæ²¡æœ‰</span><br><span class="line">st -&gt;&gt; st : å°†xå¼•ç”¨çš„å¯¹è±¡åŠ å…¥</span><br><span class="line">st --&gt;&gt; s : è¿”å› StringTable å¯¹è±¡</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>&#125;); <span class="comment">// é‡ç”Ÿçš„</span></span><br><span class="line">String z = x.intern(); <span class="comment">// é‡ç”Ÿçš„ x åŠ å…¥ StringTableï¼ŒStringTable ä¸­æœ‰äº† "abc"</span></span><br><span class="line">String y = <span class="string">"abc"</span>; <span class="comment">// å·²æœ‰ï¼Œä¸ä¼šäº§ç”Ÿæ–°çš„å¯¹è±¡ï¼Œç”¨çš„æ˜¯ StringTable ä¸­ "abc"</span></span><br><span class="line">System.out.println(z == x);</span><br><span class="line">System.out.println(z == y);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">true</span><br><span class="line">true</span><br></pre></td></tr></table></figure>



<h4 id="2-2-3å¦‚æœ-StringTable-ä¸­æ²¡æœ‰ï¼ˆ1-6-JDK-çš„åšæ³•ï¼‰"><a href="#2-2-3å¦‚æœ-StringTable-ä¸­æ²¡æœ‰ï¼ˆ1-6-JDK-çš„åšæ³•ï¼‰" class="headerlink" title="2.2.3å¦‚æœ StringTable ä¸­æ²¡æœ‰ï¼ˆ1.6 JDK çš„åšæ³•ï¼‰"></a>2.2.3å¦‚æœ StringTable ä¸­æ²¡æœ‰ï¼ˆ1.6 JDK çš„åšæ³•ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String x = ...;</span><br><span class="line">String s = x.intern();</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">participant x as x</span><br><span class="line">participant s as s</span><br><span class="line">participant st as StringTable</span><br><span class="line"></span><br><span class="line">x -&gt;&gt; st : intern()</span><br><span class="line">st -&gt;&gt; st : å¦‚æœæ²¡æœ‰</span><br><span class="line">st -&gt;&gt; st : å°†xå¼•ç”¨çš„å¯¹è±¡å¤åˆ¶</span><br><span class="line">st -&gt;&gt; st : å°†å¤åˆ¶åçš„å¯¹è±¡åŠ å…¥</span><br><span class="line">st --&gt;&gt; s : è¿”å› StringTable å¯¹è±¡</span><br></pre></td></tr></table></figure>

<p>ä¾‹å­ï¼Œä»£ç åŒä¸Šé¢ 1.7 ç›¸åŒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[]&#123;<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>&#125;); <span class="comment">// é‡ç”Ÿçš„</span></span><br><span class="line">String z = x.intern(); <span class="comment">// é‡ç”Ÿçš„ x è¢«å¤åˆ¶ååŠ å…¥ StringTableï¼ŒStringTable ä¸­æœ‰äº† "abc"</span></span><br><span class="line">String y = <span class="string">"abc"</span>; <span class="comment">// å·²æœ‰ï¼Œä¸ä¼šäº§ç”Ÿæ–°çš„å¯¹è±¡ï¼Œç”¨çš„æ˜¯ StringTable ä¸­ "abc"</span></span><br><span class="line">System.out.println(z == x);</span><br><span class="line">System.out.println(z == y);</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">false</span><br><span class="line">true</span><br></pre></td></tr></table></figure>



<h3 id="2-3-å»é‡çš„å¥½å¤„"><a href="#2-3-å»é‡çš„å¥½å¤„" class="headerlink" title="2.3 å»é‡çš„å¥½å¤„"></a>2.3 å»é‡çš„å¥½å¤„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¼”ç¤º intern å‡å°‘å†…å­˜å ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        List&lt;String&gt; address = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        System.in.read();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(<span class="string">"linux.words"</span>), <span class="string">"utf-8"</span>))) &#123;</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    line = reader.readLine();</span><br><span class="line">                    <span class="keyword">if</span>(line == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    address.add(line.intern());</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"cost:"</span> +(System.nanoTime()-start)/<span class="number">1000000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.in.read();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-4-å®¶çš„ä½ç½®"><a href="#2-4-å®¶çš„ä½ç½®" class="headerlink" title="2.4 å®¶çš„ä½ç½®"></a>2.4 å®¶çš„ä½ç½®</h3><p><strong>StringTable çš„ä½ç½®ï¼ˆ1.6ï¼‰</strong></p>
<p><img src="8.png" alt=""></p>
<p><strong>StringTable çš„ä½ç½®ï¼ˆ1.8ï¼‰</strong></p>
<p>![](</p>
<p>9.png)</p>
<p>å¦‚ä½•è¯æ˜</p>
<ul>
<li>1.6 ä¸æ–­å°†å­—ç¬¦ä¸²ç”¨ intern åŠ å…¥ StringTableï¼Œæœ€åæ’‘çˆ†çš„æ˜¯æ°¸ä¹…ä»£å†…å­˜ï¼Œä¸ºäº†è®©é”™è¯¯å¿«é€Ÿå‡ºç°ï¼Œå°†æ°¸ä¹…ä»£å†…å­˜è®¾ç½®çš„å°ä¸€äº›ï¼š<code>-XX:MaxPermSize=10m</code>ï¼Œæœ€ç»ˆä¼šå‡ºç° <code>java.lang.OutOfMemoryError: PermGen space</code></li>
<li>1.8 ä¸æ–­å°†å­—ç¬¦ä¸²ç”¨ intern åŠ å…¥ StringTableï¼Œæœ€åæ’‘çˆ†çš„æ˜¯å †å†…å­˜ï¼Œä¸ºäº†è®©é”™è¯¯å¿«é€Ÿå‡ºç°ï¼Œå°†å †å†…å­˜è®¾ç½®çš„å°ä¸€äº›ï¼š<code>-Xmx10m -XX:-UseGCOverheadLimit</code> åä¸€ä¸ªè™šæ‹Ÿæœºå‚æ•°æ˜¯é¿å… GC é¢‘ç¹å¼•èµ·å…¶ä»–é”™è¯¯è€Œä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ <code>java.lang.OutOfMemoryError: Java heap space</code></li>
</ul>
<p>ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¼”ç¤º StringTable ä½ç½®</span></span><br><span class="line"><span class="comment"> * åœ¨jdk8ä¸‹è®¾ç½® -Xmx10m -XX:-UseGCOverheadLimit</span></span><br><span class="line"><span class="comment"> * åœ¨jdk6ä¸‹è®¾ç½® -XX:MaxPermSize=10m</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">260000</span>; j++) &#123;</span><br><span class="line">                list.add(String.valueOf(j).intern());</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-5-intern-å»é‡åŸç†"><a href="#2-5-intern-å»é‡åŸç†" class="headerlink" title="2.5 intern å»é‡åŸç†"></a>2.5 intern å»é‡åŸç†</h3><p>æŸ¥é˜…ä¸€ä¸‹ jdk çš„æºç </p>
<p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5bd0e0bcb152/src/share/vm/classfile/symbolTable.cpp" target="_blank" rel="noopener">http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/5bd0e0bcb152/src/share/vm/classfile/symbolTable.cpp</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// string_or_null å­—ç¬¦ä¸²å¯¹è±¡</span></span><br><span class="line"><span class="comment">// name å­—ç¬¦ä¸²åŸå§‹æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// len å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">oop StringTable::intern(Handle string_or_null, jchar* name,</span><br><span class="line">                        <span class="keyword">int</span> len, TRAPS) &#123;</span><br><span class="line">  <span class="comment">// è·å–å­—ç¬¦ä¸²çš„ hash å€¼</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValue = hash_string(name, len);</span><br><span class="line">  <span class="comment">// ç®—å‡º hash table æ¡¶ä¸‹æ ‡  </span></span><br><span class="line">  <span class="keyword">int</span> index = the_table()-&gt;hash_to_index(hashValue);</span><br><span class="line">  <span class="comment">// çœ‹å­—ç¬¦ä¸²åœ¨ hash table ä¸­æœ‰æ²¡æœ‰ </span></span><br><span class="line">  oop found_string = the_table()-&gt;lookup(index, name, len, hashValue);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›ï¼ˆé¿å…é‡å¤åŠ å…¥ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (found_string != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">// ç¡®ä¿è¯¥å­—ç¬¦ä¸²å¯¹è±¡æ²¡æœ‰è¢«åƒåœ¾å›æ”¶  </span></span><br><span class="line">    ensure_string_alive(found_string);</span><br><span class="line">    <span class="keyword">return</span> found_string;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug_only(StableMemoryChecker smc(name, len * <span class="keyword">sizeof</span>(name[<span class="number">0</span>])));</span><br><span class="line">  assert(!Universe::heap()-&gt;is_in_reserved(name),</span><br><span class="line">         <span class="string">"proposed name of symbol must be stable"</span>);</span><br><span class="line"></span><br><span class="line">  Handle <span class="built_in">string</span>;</span><br><span class="line">  <span class="comment">// try to reuse the string if possible</span></span><br><span class="line">  <span class="keyword">if</span> (!string_or_null.is_null()) &#123;</span><br><span class="line">    <span class="built_in">string</span> = string_or_null;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ® unicode åˆ›å»ºã€å­—ç¬¦ä¸²å¯¹è±¡ stringã€‘ </span></span><br><span class="line">    <span class="built_in">string</span> = java_lang_String::create_from_unicode(name, len, CHECK_NULL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_ALL_GCS</span></span><br><span class="line">  <span class="keyword">if</span> (G1StringDedup::is_enabled()) &#123;</span><br><span class="line">    <span class="comment">// Deduplicate the string before it is interned. Note that we should never</span></span><br><span class="line">    <span class="comment">// deduplicate a string after it has been interned. Doing so will counteract</span></span><br><span class="line">    <span class="comment">// compiler optimizations done on e.g. interned string literals.</span></span><br><span class="line">    G1StringDedup::deduplicate(<span class="built_in">string</span>());</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grab the StringTable_lock before getting the_table() because it could</span></span><br><span class="line">  <span class="comment">// change at safepoint.</span></span><br><span class="line">  oop added_or_found;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function">MutexLocker <span class="title">ml</span><span class="params">(StringTable_lock, THREAD)</span></span>;</span><br><span class="line">    <span class="comment">// å°†ã€å­—ç¬¦ä¸²å¯¹è±¡ stringã€‘åŠ å…¥ hash table</span></span><br><span class="line">    added_or_found = the_table()-&gt;basic_add(index, <span class="built_in">string</span>, name, len,</span><br><span class="line">                                  hashValue, CHECK_NULL);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ensure_string_alive(added_or_found);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> added_or_found;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å…¶ä¸­ lookup çš„å®šä¹‰ä¸º</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index æ¡¶ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">// name å­—ç¬¦ä¸²åŸå§‹æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// len å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line"><span class="comment">// hash å“ˆå¸Œç </span></span><br><span class="line">oop StringTable::lookup(<span class="keyword">int</span> index, jchar* name,</span><br><span class="line">                        <span class="keyword">int</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> hash) &#123;</span><br><span class="line">  <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (HashtableEntry&lt;oop, mtSymbol&gt;* l = bucket(index); l != <span class="literal">NULL</span>; l = l-&gt;next()) &#123;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="keyword">if</span> (l-&gt;hash() == hash) &#123;</span><br><span class="line">      <span class="keyword">if</span> (java_lang_String::equals(l-&gt;literal(), name, len)) &#123;</span><br><span class="line">        <span class="keyword">return</span> l-&gt;literal();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœé“¾è¡¨è¿‡é•¿ï¼Œéœ€è¦ rehash</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt;= rehash_count &amp;&amp; !needs_rehashing()) &#123;</span><br><span class="line">    _needs_rehashing = check_rehash_table(count);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å…¶ä¸­ basic_add çš„å®šä¹‰ä¸º</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index_arg æ¡¶ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">// string å­—ç¬¦ä¸²å¯¹è±¡</span></span><br><span class="line"><span class="comment">// name å­—ç¬¦ä¸²åŸå§‹æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">// len å­—ç¬¦ä¸²é•¿åº¦</span></span><br><span class="line">oop StringTable::basic_add(<span class="keyword">int</span> index_arg, Handle <span class="built_in">string</span>, jchar* name,</span><br><span class="line">                           <span class="keyword">int</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValue_arg, TRAPS) &#123;</span><br><span class="line"></span><br><span class="line">  assert(java_lang_String::equals(<span class="built_in">string</span>(), name, len),</span><br><span class="line">         <span class="string">"string must be properly initialized"</span>);</span><br><span class="line">  <span class="comment">// Cannot hit a safepoint in this function because the "this" pointer can move.</span></span><br><span class="line">  No_Safepoint_Verifier nsv;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if the symbol table has been rehashed, if so, need to recalculate</span></span><br><span class="line">  <span class="comment">// the hash value and index before second lookup.</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValue;</span><br><span class="line">  <span class="keyword">int</span> index;</span><br><span class="line">  <span class="keyword">if</span> (use_alternate_hashcode()) &#123;</span><br><span class="line">    hashValue = hash_string(name, len);</span><br><span class="line">    index = hash_to_index(hashValue);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hashValue = hashValue_arg;</span><br><span class="line">    index = index_arg;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Since look-up was done lock-free, we need to check if another</span></span><br><span class="line">  <span class="comment">// thread beat us in the race to insert the symbol.</span></span><br><span class="line"></span><br><span class="line">  oop test = lookup(index, name, len, hashValue); <span class="comment">// calls lookup(u1*, int)</span></span><br><span class="line">  <span class="keyword">if</span> (test != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">// Entry already added</span></span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// æ„é€ æ–°çš„ HashtableEntry èŠ‚ç‚¹</span></span><br><span class="line">  HashtableEntry&lt;oop, mtSymbol&gt;* entry = new_entry(hashValue, <span class="built_in">string</span>());</span><br><span class="line">  <span class="comment">// åŠ å…¥é“¾è¡¨  </span></span><br><span class="line">  add_entry(index, entry);</span><br><span class="line">  <span class="comment">// è¿”å›å­—ç¬¦ä¸²å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">string</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-6-G1-å»é‡"><a href="#2-6-G1-å»é‡" class="headerlink" title="2.6 G1 å»é‡"></a>2.6 G1 å»é‡</h3><p>æ‡’æƒ°æ˜¯ç¨‹åºå‘˜çš„ä¸€å¤§ç¾å¾·ï¼Œä¸è¿½æ±‚æ‡’æƒ°çš„ç¨‹åºå‘˜ä¸æ˜¯å¥½ç¨‹åºå‘˜</p>
<p>å¦‚æœä½ ä½¿ç”¨çš„ JDK 8u20ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ JVM å‚æ•°å¼€å¯ G1 åƒåœ¾å›æ”¶å™¨ï¼Œå¹¶å¼€å¯å­—ç¬¦ä¸²å»é‡åŠŸèƒ½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseG1GC -XX:+UseStringDeduplication</span><br></pre></td></tr></table></figure>

<p>åŸç†æ˜¯è®©å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡å¼•ç”¨åŒä¸€ä¸ª char[] æ¥è¾¾åˆ°èŠ‚çœå†…å­˜çš„ç›®çš„</p>
<p><img src="st09.png" alt=""></p>
<p>ç‰¹ç‚¹</p>
<ul>
<li>ç”± G1 åƒåœ¾å›æ”¶å™¨åœ¨ minor gc é˜¶æ®µè‡ªåŠ¨åˆ†æä¼˜åŒ–ï¼Œä¸éœ€è¦ç¨‹åºå‘˜è‡ªå·±å¹²é¢„</li>
<li>åªæœ‰é’ˆå¯¹é‚£äº›å¤šæ¬¡å›æ”¶è¿˜ä¸æ­»çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ‰ä¼šè¿›è¡Œå»é‡ä¼˜åŒ–ï¼Œå¯ä»¥é€šè¿‡ <code>-XX:StringDeduplicationAgeThreshold=n</code> æ¥è°ƒæ•´</li>
<li>å¯ä»¥é€šè¿‡ <code>-XX:+PrintStringDeduplicationStatistics</code> æŸ¥çœ‹ G1 å»é‡çš„ç»Ÿè®¡ä¿¡æ¯</li>
<li>ä¸è°ƒç”¨ intern å»é‡ç›¸æ¯”ï¼ŒG1 å»é‡å¥½å¤„åœ¨äºè‡ªåŠ¨ï¼Œä½†ç¼ºç‚¹æ˜¯å³ä½¿ char[] ä¸é‡å¤ï¼Œä½†å­—ç¬¦ä¸²å¯¹è±¡æœ¬èº«è¿˜è¦å ç”¨ä¸€å®šå†…å­˜ï¼ˆå¯¹è±¡å¤´ã€valueå¼•ç”¨ã€hashï¼‰ï¼Œintern å»é‡æ˜¯å­—ç¬¦ä¸²å¯¹è±¡åªå­˜ä¸€ä»½ï¼Œæ›´çœå†…å­˜</li>
</ul>
<h3 id="2-7-å®¶çš„å¤§å°"><a href="#2-7-å®¶çš„å¤§å°" class="headerlink" title="2.7 å®¶çš„å¤§å°"></a>2.7 å®¶çš„å¤§å°</h3><p>StringTable è¶³å¤Ÿå¤§ï¼Œæ‰èƒ½å‘æŒ¥æ€§èƒ½ä¼˜åŠ¿ï¼Œå¤§æ„å‘³ç€ String åœ¨ hash è¡¨ä¸­å†²çªå‡å°‘ï¼Œé“¾è¡¨çŸ­ï¼Œæ€§èƒ½é«˜ã€‚</p>
<p>å¯ä»¥é€šè¿‡ <code>-XX:+PrintStringTableStatistics</code> æ¥æŸ¥çœ‹ StringTable çš„å¤§å°ï¼Œ<strong>JDK 8 ä¸­å®ƒçš„é»˜è®¤å¤§å°ä¸º 60013</strong></p>
<p><strong>è¦æ³¨æ„ StringTable åº•å±‚çš„ hash è¡¨åœ¨ JVM å¯åŠ¨åå¤§å°å°±å›ºå®šä¸å˜äº†</strong></p>
<p>è¿™ä¸ª hash è¡¨å¯ä»¥åœ¨é“¾è¡¨é•¿åº¦å¤ªé•¿æ—¶è¿›è¡Œ rehashï¼Œä½†ä¸æ˜¯åˆ©ç”¨æ‰©å®¹å®ç°çš„ rehashï¼Œè€Œæ˜¯é€šè¿‡é‡æ–°è®¡ç®—å­—ç¬¦ä¸²çš„ hash å€¼æ¥è®©å®ƒä»¬åˆ†å¸ƒå‡åŒ€</p>
<p>å¦‚æœæƒ³åœ¨å¯åŠ¨å‰è°ƒæ•´ StringTable çš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡ <code>-XX:StringTableSize=n</code> æ¥æŒ‡å®š</p>
<p>ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¼”ç¤ºä¸²æ± å¤§å°å¯¹æ€§èƒ½çš„å½±å“</span></span><br><span class="line"><span class="comment"> * -XX:+PrintStringTableStatistics -XX:StringTableSize=1009</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(<span class="string">"linux.words"</span>), <span class="string">"utf-8"</span>))) &#123;</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                line = reader.readLine();</span><br><span class="line">                <span class="keyword">if</span> (line == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                line.intern();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"cost:"</span> + (System.nanoTime() - start) / <span class="number">1000000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-8-å­—ç¬¦ä¸²ä¹‹æ­»"><a href="#2-8-å­—ç¬¦ä¸²ä¹‹æ­»" class="headerlink" title="2.8 å­—ç¬¦ä¸²ä¹‹æ­»"></a>2.8 å­—ç¬¦ä¸²ä¹‹æ­»</h3><p>å­—ç¬¦ä¸²ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåªè¦æ˜¯å¯¹è±¡ï¼Œç»ˆç©¶é€ƒä¸è¿‡æ­»äº¡çš„å‘½è¿ã€‚å­—ç¬¦ä¸²å¯¹è±¡ä¸å…¶å®ƒ Java å¯¹è±¡ä¸€æ ·ï¼Œåªè¦å¤±å»äº†åˆ©ç”¨ä»·å€¼ï¼Œå°±ä¼šè¢«åƒåœ¾å›æ”¶ï¼Œæ— è®ºæ˜¯é‡ç”Ÿå­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯å®¶å…»å­—ç¬¦ä¸²</p>
<p>æ€ä¹ˆè¯æ˜å®¶å…»çš„å­—ç¬¦ä¸²ä¹Ÿèƒ½è¢«åƒåœ¾å›æ”¶å‘¢ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹ JVM å‚æ•°æ¥æŸ¥çœ‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</span><br></pre></td></tr></table></figure>

<p>ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¼”ç¤º StringTable åƒåœ¾å›æ”¶</span></span><br><span class="line"><span class="comment"> * -Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">100000</span>; j++) &#123; <span class="comment">// j=100, j=10000</span></span><br><span class="line">                String.valueOf(j).intern();</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ä¸‰ã€é¢è¯•é¢˜è®²è§£"><a href="#ä¸‰ã€é¢è¯•é¢˜è®²è§£" class="headerlink" title="ä¸‰ã€é¢è¯•é¢˜è®²è§£"></a>ä¸‰ã€é¢è¯•é¢˜è®²è§£</h2><p><strong>1. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String str1 = <span class="string">"string"</span>; <span class="comment">// å®¶</span></span><br><span class="line">String str2 = <span class="keyword">new</span> String(<span class="string">"string"</span>); <span class="comment">// é‡ç”Ÿ</span></span><br><span class="line">String str3 = str2.intern(); <span class="comment">// å®¶</span></span><br><span class="line"></span><br><span class="line">System.out.println(str1==str2);<span class="comment">//#1  false</span></span><br><span class="line">System.out.println(str1==str3);<span class="comment">//#2  true</span></span><br></pre></td></tr></table></figure>
<p><strong>2. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">String baseStr = <span class="string">"baseStr"</span>;</span><br><span class="line"><span class="keyword">final</span> String baseFinalStr = <span class="string">"baseStr"</span>;</span><br><span class="line"></span><br><span class="line">String str1 = <span class="string">"baseStr01"</span>; <span class="comment">// å®¶</span></span><br><span class="line">String str2 = <span class="string">"baseStr"</span>+<span class="string">"01"</span>; <span class="comment">// å®¶</span></span><br><span class="line">String str3 = baseStr + <span class="string">"01"</span>; <span class="comment">// é‡ç”Ÿ</span></span><br><span class="line">String str4 = baseFinalStr+<span class="string">"01"</span>;<span class="comment">// å®¶</span></span><br><span class="line">String str5 = <span class="keyword">new</span> String(<span class="string">"baseStr01"</span>).intern(); <span class="comment">// å®¶</span></span><br><span class="line"></span><br><span class="line">System.out.println(str1 == str2);<span class="comment">//#3 true</span></span><br><span class="line">System.out.println(str1 == str3);<span class="comment">//#4 false </span></span><br><span class="line">System.out.println(str1 == str4);<span class="comment">//#5 true</span></span><br><span class="line">System.out.println(str1 == str5);<span class="comment">//#6 true</span></span><br></pre></td></tr></table></figure>
<p><strong>3. åˆ¤æ–­è¾“å‡ºï¼ˆæ³¨æ„ç‰ˆæœ¬ï¼‰</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String str2 = <span class="keyword">new</span> String(<span class="string">"str"</span>)+<span class="keyword">new</span> String(<span class="string">"01"</span>);</span><br><span class="line">str2.intern(); <span class="comment">//1.6</span></span><br><span class="line">String str1 = <span class="string">"str01"</span>;</span><br><span class="line">System.out.println(str2==str1);<span class="comment">//#7 1.7 true, 1.6 false</span></span><br></pre></td></tr></table></figure>
<p><strong>4. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String str1 = <span class="string">"str01"</span>;</span><br><span class="line">String str2 = <span class="keyword">new</span> String(<span class="string">"str"</span>)+<span class="keyword">new</span> String(<span class="string">"01"</span>);</span><br><span class="line">str2.intern();</span><br><span class="line">System.out.println(str2 == str1);<span class="comment">//#8 false</span></span><br></pre></td></tr></table></figure>
<p><strong>5. String s = new String(â€œxyzâ€)ï¼Œåˆ›å»ºäº†å‡ ä¸ªString Object?</strong></p>
<p><strong>6. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"abc"</span>;</span><br><span class="line">String s2 = <span class="string">"abc"</span>;</span><br><span class="line">System.out.println(s1 == s2); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>
<p><strong>7. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="keyword">new</span> String(<span class="string">"abc"</span>);</span><br><span class="line">String s2 = <span class="keyword">new</span> String(<span class="string">"abc"</span>);</span><br><span class="line">System.out.println(s1 == s2); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p><strong>8. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"abc"</span>;</span><br><span class="line">String s2 = <span class="string">"a"</span>;</span><br><span class="line">String s3 = <span class="string">"bc"</span>;</span><br><span class="line">String s4 = s2 + s3;</span><br><span class="line">System.out.println(s1 == s4); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>
<p><strong>9. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String s1 = <span class="string">"abc"</span>;</span><br><span class="line"><span class="keyword">final</span> String s2 = <span class="string">"a"</span>;</span><br><span class="line"><span class="keyword">final</span> String s3 = <span class="string">"bc"</span>;</span><br><span class="line">String s4 = s2 + s3;</span><br><span class="line">System.out.println(s1 == s4);<span class="comment">//true</span></span><br></pre></td></tr></table></figure>
<p><strong>10. åˆ¤æ–­è¾“å‡º</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="keyword">new</span> String(<span class="string">"abc"</span>); <span class="comment">// é‡ç”Ÿ</span></span><br><span class="line">String s1 = <span class="string">"abc"</span>; <span class="comment">// å®¶</span></span><br><span class="line">String s2 = <span class="keyword">new</span> String(<span class="string">"abc"</span>); <span class="comment">// é‡ç”Ÿ</span></span><br><span class="line">System.out.println(s == s1.intern()); <span class="comment">// false</span></span><br><span class="line">System.out.println(s == s2.intern()); <span class="comment">// false</span></span><br><span class="line">System.out.println(s1 == s2.intern()); <span class="comment">// true</span></span><br></pre></td></tr></table></figure></div><div class="post-copyright"><blockquote><p>åŸæ–‡ä½œè€…: æ˜é‡‘æœ¨åŒ </p><p>åŸæ–‡é“¾æ¥: <a href="http://goldcarpenter.github.io/2019/11/01/Stringæ€»ç»“/">http://goldcarpenter.github.io/2019/11/01/Stringæ€»ç»“/</a></p><p>ç‰ˆæƒå£°æ˜: è½¬è½½è¯·æ³¨æ˜å‡ºå¤„(å¿…é¡»ä¿ç•™ä½œè€…ç½²ååŠé“¾æ¥)</p></blockquote></div><div class="tags"><a href="/tags/JVM/">JVM</a><a href="/tags/String/">String</a></div><div class="post-share"><div class="social-share"><span>åˆ†äº«åˆ°:</span></div></div><div class="post-nav"><a href="/2019/11/05/SpringMVC_Part1/" class="pre">SpringMVC</a><a href="/2019/09/22/Spring_AOP/" class="next">Spring FrameWork</a></div><div id="comments"><div id="SOHUCS" sid="2019/11/01/Stringæ€»ç»“/"></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">æ–‡ç« ç›®å½•</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Stringåº•å±‚æ€»ç»“"><span class="toc-text">Stringåº•å±‚æ€»ç»“</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼"><span class="toc-text">1.å­—ç¬¦ä¸²åˆ›å»ºæ–¹å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-char-æ•°ç»„åˆ›å»º"><span class="toc-text">1.1 char[] æ•°ç»„åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-byte-æ•°ç»„åˆ›å»º"><span class="toc-text">1.2 byte[] æ•°ç»„åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-int-æ•°ç»„åˆ›å»º"><span class="toc-text">1.3 int[] æ•°ç»„åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º"><span class="toc-text">1.4 ä»å·²æœ‰å­—ç¬¦ä¸²åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-å­—é¢é‡åˆ›å»º"><span class="toc-text">1.5 å­—é¢é‡åˆ›å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-1éå¯¹è±¡"><span class="toc-text">1.5.1éå¯¹è±¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-2æ‡’åŠ è½½"><span class="toc-text">1.5.2æ‡’åŠ è½½</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-3ä¸é‡å¤"><span class="toc-text">1.5.3ä¸é‡å¤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-æ‹¼æ¥åˆ›å»º"><span class="toc-text">1.5 æ‹¼æ¥åˆ›å»º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6-JDK-9-ä¹‹åçš„æ”¹å˜"><span class="toc-text">1.6 JDK 9 ä¹‹åçš„æ”¹å˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-1å†…å­˜ç»“æ„æ”¹å˜"><span class="toc-text">1.6.1å†…å­˜ç»“æ„æ”¹å˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-2æ‹¼æ¥æ–¹å¼æ”¹å˜"><span class="toc-text">1.6.2æ‹¼æ¥æ–¹å¼æ”¹å˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-3é»˜è®¤æ‹¼æ¥ç­–ç•¥"><span class="toc-text">1.6.3é»˜è®¤æ‹¼æ¥ç­–ç•¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-4æ¨¡ä»¿-BC-SB-ç­–ç•¥"><span class="toc-text">1.6.4æ¨¡ä»¿ BC_SB ç­–ç•¥</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ"><span class="toc-text">1. æ–¹æ³•æ‰‹åŠ¨ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•"><span class="toc-text">2. å­—èŠ‚ç ç”Ÿæˆæ–¹æ³•</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-å­—ç¬¦ä¸²ä¹‹å®¶-StringTable"><span class="toc-text">2.å­—ç¬¦ä¸²ä¹‹å®¶ - StringTable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-å®¶å…»ä¸é‡ç”Ÿ"><span class="toc-text">2.1 å®¶å…»ä¸é‡ç”Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²"><span class="toc-text">2.2 æ”¶ç•™é‡ç”Ÿå­—ç¬¦ä¸²</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1å¦‚æœ-StringTable-ä¸­å·²æœ‰"><span class="toc-text">2.2.1å¦‚æœ StringTable ä¸­å·²æœ‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2å¦‚æœ-StringTable-ä¸­æ²¡æœ‰ï¼ˆ1-7-ä»¥ä¸Š-JDK-çš„åšæ³•ï¼‰"><span class="toc-text">2.2.2å¦‚æœ StringTable ä¸­æ²¡æœ‰ï¼ˆ1.7 ä»¥ä¸Š JDK çš„åšæ³•ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3å¦‚æœ-StringTable-ä¸­æ²¡æœ‰ï¼ˆ1-6-JDK-çš„åšæ³•ï¼‰"><span class="toc-text">2.2.3å¦‚æœ StringTable ä¸­æ²¡æœ‰ï¼ˆ1.6 JDK çš„åšæ³•ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-å»é‡çš„å¥½å¤„"><span class="toc-text">2.3 å»é‡çš„å¥½å¤„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-å®¶çš„ä½ç½®"><span class="toc-text">2.4 å®¶çš„ä½ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-intern-å»é‡åŸç†"><span class="toc-text">2.5 intern å»é‡åŸç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-G1-å»é‡"><span class="toc-text">2.6 G1 å»é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-å®¶çš„å¤§å°"><span class="toc-text">2.7 å®¶çš„å¤§å°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-å­—ç¬¦ä¸²ä¹‹æ­»"><span class="toc-text">2.8 å­—ç¬¦ä¸²ä¹‹æ­»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸‰ã€é¢è¯•é¢˜è®²è§£"><span class="toc-text">ä¸‰ã€é¢è¯•é¢˜è®²è§£</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> æœ€æ–°æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/04/17/Redis_Part3/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/04/Redis_Part2/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/29/Nginx%E5%9F%BA%E7%A1%80/">Nginx</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/26/Redis_Part1/">Redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/29/jdk8%E6%96%B0%E7%89%B9%E6%80%A7_Part3/">JDK8æ–°ç‰¹æ€§</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/29/jdk8%E6%96%B0%E7%89%B9%E6%80%A7_Part2/">JDK8æ–°ç‰¹æ€§</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/25/jdk8%E6%96%B0%E7%89%B9%E6%80%A7_Part1/">JDK8æ–°ç‰¹æ€§</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/02/javaIO/">JavaIO</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/21/ThreadLocal/">ThreadLocalæ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/19/SpringMVC_Part3/">SpringMVC</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Debug%E8%AE%B0%E5%BD%95/">Debugè®°å½•</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">JavaåŸºç¡€</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E9%AB%98%E7%BA%A7/">Javaé«˜çº§</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL%E5%9F%BA%E7%A1%80/">MySQLåŸºç¡€</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%BC%80%E5%8F%91/">Webå¼€å‘</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">åšå®¢æ­å»º</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/github/" style="font-size: 15px;">github</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 15px;">æ³¨è§£</a> <a href="/tags/String/" style="font-size: 15px;">String</a> <a href="/tags/%E5%86%85%E9%83%A8%E7%B1%BB/" style="font-size: 15px;">å†…éƒ¨ç±»</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/ThreadLocal/" style="font-size: 15px;">ThreadLocal</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 15px;">å¤šçº¿ç¨‹</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/IEDA/" style="font-size: 15px;">IEDA</a> <a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/SpringMVC/" style="font-size: 15px;">SpringMVC</a> <a href="/tags/MyBatis/" style="font-size: 15px;">MyBatis</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> å½’æ¡£</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">34</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.scu.edu.cn/" title="å››å·å¤§å­¦é¦–é¡µ" target="_blank">å››å·å¤§å­¦é¦–é¡µ</a><ul></ul><a href="http://www.scu.edu.cn/" title="ä¸ªäººé¡¹ç›®â€”â€”å¾…å®Œå–„" target="_blank">ä¸ªäººé¡¹ç›®â€”â€”å¾…å®Œå–„</a><ul></ul><a href="http://www.scu.edu.cn/" title="ä¸ªäººé¡¹ç›®â€”â€”å¾…å®Œå–„" target="_blank">ä¸ªäººé¡¹ç›®â€”â€”å¾…å®Œå–„</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">ç½‘ç«™åœ°å›¾</a> |  <a href="/atom.xml">è®¢é˜…æœ¬ç«™</a> |  <a href="/about/">è”ç³»åšä¸»</a></p><p>æœ¬ç«™æ€»è®¿é—®é‡ï¼š<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>æ¬¡ï¼Œæœ¬ç«™æ€»è®¿å®¢æ•°:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>äºº</p><p><span> Copyright &copy;<a href="/." rel="nofollow">æ˜é‡‘æœ¨åŒ .</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script>window._config = { showScore: true };
(function(){ 
  var appid = 'cyuBR2wWE'; 
  var conf = 'cbd82aee65d05c481319a299102b4811'; 
  var width = window.innerWidth || document.documentElement.clientWidth; 
  var nodes =document.getElementsByTagName("head")[0]||document.head||document.documentElement;
  if (/(Android|iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent) && width < 750) {  
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>');
  }
  else { 
    var loadJs=function(d,a){
      var b=document.createElement("script");b.setAttribute("type","text/javascript");
      b.setAttribute("charset","UTF-8");
      b.setAttribute("src",d);
      if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}
      nodes.appendChild(b)
    };
    loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); 
  } 
  var loadCss = function(cssString){  
    var style=document.createElement("style");  
    style.setAttribute("type", "text/css");  
    if(style.styleSheet){// IE  
        style.styleSheet.cssText = cssString;  
    } else {// w3c  
        var cssText = document.createTextNode(cssString);  
        style.appendChild(cssText);  
    }
    nodes.appendChild(style);
  }
  //- window.onload=function(){
  //-   if(window.outerWidth<=775){
  //-     loadCss('.module-hot-topic,.module-cmt-float-bar{display:none!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .cbox-prompt-w span.prompt-empty-w,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w .form-text-w span.text-null,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w a.comment-link-w,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-minwidth-w div.cont-comment-w span.comment-text-w,#SOHUCS #SOHU_MAIN .module-cmt-footer .section-service-w div.service-wrap-w a:hover,#SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login,#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w span.wrap-name-w,#SOHUCS #SOHU_MAIN .module-cmt-list .action-click-gw span.click-disable-eg a em.icon-name-bg,#SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li div.title-name-gw,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number .comment-number span.cy-number,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .cmt-list-number span.comment-number,#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active,#SOHUCS #SOHU_MAIN .module-cmt-list .msg-wrap-gw .wrap-action-gw .action-click-gw span a:hover,#SOHUCS #SOHU_MAIN .module-cmt-list .picture-box-gw div.box-action-gw a:hover,#SOHUCS #SOHU_MAIN .module-cmt-list .wrap-action-gw .action-click-gw span a:hover em.icon-name-bg,#SOHUCS #SOHU_MAIN .module-cmt-list .wrap-user-gw span.user-name-gw a{color:#40759b!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-r,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-l,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-border-r{display:none!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .post-wrap-border-t div.post-wrap-border-t-l{background:#FFF!important;top:-2px!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-function-w .uploading-wrapper-dw div.wrapper-image-dw,#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w div.post-wrap-main,#SOHUCS #SOHU_MAIN .module-cmt-float-bar .wrap-cont-w .cont-form-w div.form-text-w,#SOHUCS #SOHU_MAIN .module-cmt-header .section-cbox-w .block-head-w div.header-login,#SOHUCS #SOHU_MAIN .module-cmt-list .module-cmt-box .post-wrap-w div.post-wrap-main{border:1px solid #e6e6e6!important;border-radius:20px 20px 20px 20px;margin:0!important}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw{width:130px!important;height:34px!important;line-height:33px!important;font-size:17px!important;background:#5483b1!important;border-radius:20px!important;color:#FFF!important;-webkit-box-shadow:0 -1px 4px #5483b1 inset;box-shadow:0 -1px 10px #5483b1 inset}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a .btn-fw:before{content:"å‘è¡¨è¯„è®º"}#SOHUCS #SOHU_MAIN .module-cmt-box .post-wrap-w .wrap-action-w .action-issue-w .issue-btn-w a:hover .btn-fw{color:#40759b!important;background:#FFF!important}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li{background:none!important;border-bottom:1px solid #e6e6e6}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type .type-lists li.active{border:1px solid #e6e6e6;border-radius:10px 10px 0 0;border-bottom:none}#SOHUCS #SOHU_MAIN .module-cmt-list .block-title-gw ul li .title-name-gw div.title-name-gw-tag{background:#5483b1!important;border-radius:3px}#SOHUCS #SOHU_MAIN .module-cmt-list .cmt-list-type div.cmt-list-border{background-color:#e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item{border:1px solid #e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo{text-align:center;line-height:40px;border-radius:50%!important;background:#e6e6e6!important}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item .nt-logo:before{content:"ç•…";font-size:22px;color:#FFF}#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text,#SOHUCS #SOHU_MAIN .module-cmt-notice ul.nt-list li.nt-item a.nt-text i{color:#5483b1!important}#SOHUCS #SOHU_MAIN .module-cmt-header .section-title-w .title-user-w .user-wrap-w{background:#FFF!important}@media screen and (min-width:900px){#SOHUCS #SOHU_MAIN .module-mobile-cmt-list .list-wrapper-wap .list-container-wap .list-item-wap .list-content-wrapper-wap .cmt-list-image-container .cmt-list-image{max-width: 100%;}}');
  //-   }
  //- };
})();
function removeElement(_element){
     var _parentElement = _element.parentNode;
     if(_parentElement){
            _parentElement.removeChild(_element);
     }
}
var removeAD = document.createElement("div");
removeAD.id = 'removeAD';
var adInterval1 = setInterval(function() {
  if(document.querySelector("#feedAv")){
    document.querySelector("[node-type=cmt-list]").appendChild(removeAD);
    document.querySelector("#removeAD").appendChild(document.querySelector("#feedAv"));
    //- removeElement(document.querySelectorAll("#feedAv")[0]);
    var feedAv = document.querySelector("#feedAv").children;
    for( item of feedAv){
      item.style.display = 'none'
    }
    document.querySelector("#removeAD").style.display="none"
    clearInterval(adInterval1);
  }
},1000);
var adInterval2 = setInterval(function() {
  if(document.querySelector("#pop_ad")){
    removeElement(document.querySelector("#pop_ad"));
    clearInterval(adInterval2);
  }
}, 1000);</script><script src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script></body></html>